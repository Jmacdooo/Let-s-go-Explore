<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Forever Dog ‚Äî Parks</title>
  <style>
    body{
      margin:0;
      background:#bde0fe;
      overflow:hidden;
      font-family: system-ui, -apple-system, sans-serif;
    }
    canvas{
      display:block;
      width:100vw;
      height:100vh;
    }
    #controls{
      position:fixed;
      left:10px;
      top:10px;
      z-index:10;
      background:rgba(255,255,255,.9);
      padding:8px 10px;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,.2);
    }
    button{
      padding:8px 10px;
      margin:2px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:600;
      background:#ffb703;
    }
    #msg{
      position:fixed;
      left:50%;
      bottom:12px;
      transform:translateX(-50%);
      background:rgba(255,255,255,.95);
      padding:8px 14px;
      border-radius:14px;
      box-shadow:0 4px 12px rgba(0,0,0,.2);
      font-size:14px;
      max-width:90vw;
      text-align:center;
    }
  </style>
</head>
<body>
  <div id="controls">
    <button id="leftBtn">‚¨Ö Walk</button>
    <button id="stopBtn">‚è∏ Stop</button>
    <button id="rightBtn">Walk ‚û°</button>
    <button id="petBtn">‚ù§Ô∏è Pet</button>
    <button id="feedBtn">üçñ Feed</button>
  </div>

  <div id="msg">Walk to visit the national parks!</div>
  <canvas id="game"></canvas>

  <script>
    /* =========================================================
       My Forever Dog ‚Äî Parks (Yosemite background version)

       - Big dog (walk + idle same size, same ground)
       - Walk, Stop, Pet, Feed
       - Bark ONLY on Pet + Feed
       - Guide + Dog voices at landmarks
       - Yosemite photo behind the scene
       - NEW: Half Dome photo background when you arrive at Half Dome
       ========================================================= */

    // ---------- canvas ----------
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const msgEl = document.getElementById("msg");

    function resize(){
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resize);
    resize();

    // where the FEET go
    function dogGroundY(){
      return canvas.height - 70;
    }
    function signGroundY(){
      return canvas.height - 150;
    }

    // how tall the actual dog body should appear
    const DOG_BODY_SCREEN_HEIGHT = 320;
    const WALK_FRAMES = 5;

    // ---------- audio ----------
    let barkSound = null;
    try {
      barkSound = new Audio("assets/bark.mp3");
    } catch(e) {
      console.warn("bark.mp3 not found yet");
    }

    function playBark(){
      if(!barkSound) return;
      barkSound.currentTime = 0;
      barkSound.play().catch(()=>{});
    }

    // ---------- Yosemite background image ----------
    const bgImage = new Image();
    bgImage.src = "assets/yosemite.png";

    // ---------- Half Dome background image (NEW) ----------
    // Put your file at: assets/half_dome.png
    const halfDomeImage = new Image();
    halfDomeImage.src = "assets/half_dome.png";

    // background override state (NEW)
    let bgOverride = null;       // "half_dome" or null
    let bgOverrideTimer = 0;     // frames remaining

    // ---------- parks ----------
    const parks = [
      {
        id: "half_dome",
        name:"Half Dome",
        subtitle:"Yosemite",
        pos:0.30,
        visited:false,
        guideLine:"This is Half Dome, a huge granite rock shaped by glaciers.",
        dogLine:"Whoa! It‚Äôs gigantic! Can we climb just the tiny part?"
      },
      {
        id: "yose_falls",
        name:"Yosemite Falls",
        subtitle:"Upper & Lower Falls",
        pos:0.60,
        visited:false,
        guideLine:"These are Yosemite Falls, some of the tallest waterfalls in North America.",
        dogLine:"I can almost feel the mist on my nose!"
      },
      {
        id: "tunnel_view",
        name:"Tunnel View",
        subtitle:"Famous lookout",
        pos:0.90,
        visited:false,
        guideLine:"Tunnel View shows Half Dome, El Capitan, and Bridalveil Fall all together.",
        dogLine:"This is the perfect place for a picture of us!"
      }
    ];

    // ---------- sprite meta ----------
    const images = {};
    const meta = {};
    // meta[state] = { frameW, frameH, contentHeight, bottomMargin }

    function loadSprite(state, filename, frames){
      const img = new Image();
      img.src = "assets/" + filename;
      img.onload = ()=> analyzeSprite(state, img, frames);
      images[state] = img;
    }

    function analyzeSprite(state, img, frames){
      const frameW = img.width / frames;
      const frameH = img.height;

      const off = document.createElement("canvas");
      off.width = frameW;
      off.height = frameH;
      const octx = off.getContext("2d");
      octx.clearRect(0,0,frameW,frameH);
      octx.drawImage(img, 0, 0, frameW, frameH, 0, 0, frameW, frameH);

      const data = octx.getImageData(0,0,frameW,frameH).data;

      let top = frameH, bottom = -1;
      for(let y=0;y<frameH;y++){
        for(let x=0;x<frameW;x++){
          const idx = (y*frameW + x)*4;
          const alpha = data[idx+3];
          if(alpha > 10){
            if(y < top) top = y;
            if(y > bottom) bottom = y;
          }
        }
      }

      if(bottom === -1){
        meta[state] = { frameW, frameH, contentHeight: frameH, bottomMargin: 0 };
        return;
      }

      const contentHeight = bottom - top + 1;
      const bottomMargin = (frameH - 1) - bottom;
      meta[state] = { frameW, frameH, contentHeight, bottomMargin };
    }

    // load walking + idle (your PNGs)
    loadSprite("walk", "dog_walk.png", WALK_FRAMES);
    loadSprite("idle", "dog_idle.png", 1);

    // ---------- SPEECH: guide + dog voice ----------
    let guideVoice = null;
    let dogVoice = null;

    function initVoices(){
      if (!("speechSynthesis" in window)) return;
      const voices = window.speechSynthesis.getVoices();
      if (!voices || !voices.length) return;

      // GUIDE: calm English voice
      guideVoice =
        voices.find(v => v.name.includes("Google UK English Female")) ||
        voices.find(v => v.name.includes("Google US English")) ||
        voices.find(v => v.lang.startsWith("en")) ||
        voices[0];

      // DOG: different but still English & clear
      dogVoice =
        voices.find(
          v =>
            v !== guideVoice &&
            v.lang.startsWith("en") &&
            /child|girl|boy|Google UK English|Google US English/i.test(
              v.name + v.voiceURI
            )
        ) ||
        voices.find(v => v !== guideVoice && v.lang.startsWith("en")) ||
        voices.find(v => v !== guideVoice) ||
        guideVoice;

      console.log("Guide voice:", guideVoice && guideVoice.name);
      console.log("Dog voice:", dogVoice && dogVoice.name);
    }

    if ("speechSynthesis" in window) {
      window.speechSynthesis.onvoiceschanged = initVoices;
      initVoices();
    }

    function speakForLandmark(p, index, total) {
      const guideText = `Landmark ${index} of ${total}: ${p.name}. ${p.guideLine || ""}`;
      const dogText = p.dogLine || "";

      // Always show text so kids see something, even if speech fails
      showMsg(guideText + (dogText ? " " + dogText : ""));

      if (!("speechSynthesis" in window)) return;

      const synth = window.speechSynthesis;
      synth.cancel(); // stop anything older

      // GUIDE
      const guideUtter = new SpeechSynthesisUtterance(guideText);
      if (guideVoice) guideUtter.voice = guideVoice;
      guideUtter.rate = 0.9;  // slower, clear
      guideUtter.pitch = 1.0; // natural

      // When GUIDE finishes, DOG talks
      guideUtter.onend = () => {
        if (!dogText) return;
        const dogUtter = new SpeechSynthesisUtterance(dogText);
        if (dogVoice || guideVoice) dogUtter.voice = dogVoice || guideVoice;
        dogUtter.rate = 1.05;  // slightly faster
        dogUtter.pitch = 1.3;  // child-like but not squeaky
        synth.speak(dogUtter);
      };

      synth.speak(guideUtter);
    }

    // ---------- dog state ----------
    const dog = {
      x: canvas.width * 0.15,
      dir: 1,
      speed: 7,
      state: "idle", // "idle" or "walk"
      frame: 0
    };

    let left = false;
    let right = false;

    // ---------- controls ----------
    const leftBtn = document.getElementById("leftBtn");
    const rightBtn = document.getElementById("rightBtn");
    const stopBtn = document.getElementById("stopBtn");
    const petBtn = document.getElementById("petBtn");
    const feedBtn = document.getElementById("feedBtn");

    function stopMoving(){
      left = right = false;
      dog.state = "idle";
    }

    // WALK LEFT ‚Äî NO BARK
    leftBtn.onclick = function(){
      left = true;
      right = false;
      dog.dir = -1;
      dog.state = "walk";
      if ("speechSynthesis" in window) window.speechSynthesis.cancel();
    };

    // WALK RIGHT ‚Äî NO BARK
    rightBtn.onclick = function(){
      right = true;
      left = false;
      dog.dir = 1;
      dog.state = "walk";
      if ("speechSynthesis" in window) window.speechSynthesis.cancel();
    };

    // STOP
    stopBtn.onclick = function(){
      stopMoving();
      if ("speechSynthesis" in window) window.speechSynthesis.cancel();
    };

    // PET ‚Äî BARK HERE
    petBtn.onclick = function(){
      stopMoving();
      playBark();
      showMsg("Your dog loves pets ‚ù§Ô∏è");
    };

    // FEED ‚Äî BARK HERE
    feedBtn.onclick = function(){
      stopMoving();
      playBark();
      showMsg("Yum! Snack time üçñ");
    };

    // keyboard support
    window.addEventListener("keydown", function(e){
      if(e.key === "ArrowLeft") leftBtn.onclick();
      if(e.key === "ArrowRight") rightBtn.onclick();
      if(e.key === " ") stopBtn.onclick();
    });

    // ---------- messages ----------
    let msgTimer = 0;
    function showMsg(text){
      msgEl.textContent = text;
      msgTimer = 240; // about 4 seconds
    }

    // ---------- update ----------
    function update(){
      if(dog.state === "walk"){
        if(left) dog.x -= dog.speed;
        if(right) dog.x += dog.speed;
      }

      // clamp on screen
      dog.x = Math.max(60, Math.min(canvas.width - 60, dog.x));

      // check parks
      const dogCenter = dog.x;
      parks.forEach((p, i) => {
        const px = p.pos * canvas.width;
        if (!p.visited && Math.abs(dogCenter - px) < 45 && dog.state === "walk") {
          stopMoving();
          p.visited = true;

          // NEW: Half Dome background swap on arrival (no bark)
          if (p.id === "half_dome") {
            bgOverride = "half_dome";
            bgOverrideTimer = 600; // ~10 seconds at ~60fps
          }

          // NO bark here (only Pet/Feed)
          speakForLandmark(p, i + 1, parks.length);
        }
      });

      // NEW: background timer countdown
      if (bgOverrideTimer > 0) {
        bgOverrideTimer--;
        if (bgOverrideTimer === 0) bgOverride = null;
      }

      if(msgTimer > 0){
        msgTimer--;
        if(msgTimer === 0){
          msgEl.textContent = "Walk to visit the national parks!";
        }
      }

      dog.frame++;
    }

    // ---------- draw helpers ----------
    function drawBackground(){
      // NEW: choose which background to draw
      let bgToDraw = bgImage;
      if (bgOverride === "half_dome" && halfDomeImage.complete && halfDomeImage.naturalWidth > 0) {
        bgToDraw = halfDomeImage;
      }

      // draw photo if loaded; else blue sky
      if (bgToDraw.complete && bgToDraw.naturalWidth > 0) {
        const iw = bgToDraw.naturalWidth;
        const ih = bgToDraw.naturalHeight;
        const scale = Math.max(canvas.width / iw, canvas.height / ih);
        const dw = iw * scale;
        const dh = ih * scale;
        const dx = (canvas.width - dw) / 2;
        const dy = (canvas.height - dh) / 2;
        ctx.drawImage(bgToDraw, dx, dy, dw, dh);
      } else {
        ctx.fillStyle = "#bde0fe";
        ctx.fillRect(0,0,canvas.width,canvas.height);
      }

      // ground strip so the dog has a floor
      const gy = dogGroundY();
      ctx.fillStyle = "#90e0ef";
      ctx.fillRect(0, gy, canvas.width, canvas.height - gy);
    }

    function drawParks(){
      const sg = signGroundY();
      ctx.textBaseline = "middle";

      parks.forEach(p => {
        const x = p.pos * canvas.width;
        const signTop = sg - 120;

        // pole
        ctx.fillStyle = "rgba(0,0,0,0.35)";
        ctx.fillRect(x - 3, signTop + 20, 6, 100);

        // sign
        ctx.fillStyle = "rgba(255,255,255,0.96)";
        ctx.fillRect(x - 90, signTop, 180, 44);

        ctx.fillStyle = "#000";
        ctx.font = "15px system-ui";
        ctx.fillText(p.name, x - 80, signTop + 14);

        ctx.font = "12px system-ui";
        ctx.fillText(p.subtitle, x - 80, signTop + 30);

        ctx.fillStyle = p.visited ? "#2a9d8f" : "#e76f51";
        ctx.beginPath();
        ctx.arc(x + 70, signTop + 22, 7, 0, Math.PI*2);
        ctx.fill();
      });
    }

    function drawDog(){
      const state = (dog.state === "walk") ? "walk" : "idle";
      const img = images[state];
      const info = meta[state];
      if(!img || !img.complete || !info) return;

      const frames = (state === "walk") ? WALK_FRAMES : 1;
      const frameW = info.frameW;
      const frameH = info.frameH;
      const contentHeight = info.contentHeight;
      const bottomMargin = info.bottomMargin;

      const bodyScale = DOG_BODY_SCREEN_HEIGHT / contentHeight;
      const drawW = frameW * bodyScale;
      const drawH = frameH * bodyScale;
      const bottomMarginScaled = bottomMargin * bodyScale;

      let frameIndex = 0;
      if(state === "walk" && frames > 1){
        frameIndex = Math.floor(dog.frame / 6) % frames contributes
        // this line was a typo; keep the original logic:
        // frameIndex = Math.floor(dog.frame / 6) % frames;
      }

      // FIX the accidental typo line above by forcing the correct line:
      if(state === "walk" && frames > 1){
        frameIndex = Math.floor(dog.frame / 6) % frames;
      }

      const sx = frameIndex * frameW;
      const gx = dog.x;
      const gy = dogGroundY();
      const dx = gx - drawW / 2;
      const dy = gy - (drawH - bottomMarginScaled);

      ctx.save();
      if(dog.dir < 0){
        ctx.scale(-1,1);
        ctx.drawImage(
          img,
          sx, 0, frameW, frameH,
          -dx - drawW, dy,
          drawW, drawH
        );
      } else {
        ctx.drawImage(
          img,
          sx, 0, frameW, frameH,
          dx, dy,
          drawW, drawH
        );
      }
      ctx.restore();
    }

    // ---------- main loop ----------
    function loop(){
      update();
      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawBackground();
      drawParks();
      drawDog();
      requestAnimationFrame(loop);
    }
    loop();
  </script>
</body>
</html>
