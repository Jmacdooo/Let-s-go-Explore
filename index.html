<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>My Forever Dog ‚Äî National Parks Road Trip</title>
<style>
  html,body{
    margin:0;
    height:100%;
    overflow:hidden;
    font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif;
    background:#cfe9ff;
  }
  canvas{
    display:block;
    width:100vw;
    height:100vh;
  }

  /* Top bar */
  #topbar{
    position:fixed;
    left:12px;
    top:12px;
    z-index:10;
    background:rgba(255,255,255,.92);
    box-shadow:0 10px 30px rgba(0,0,0,.15);
    border-radius:14px;
    padding:10px 12px;
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
    font-size:12px;
  }
  #topbar b{font-size:13px}
  #topbar .pill{
    background:#fff;
    border:1px solid rgba(0,0,0,.12);
    border-radius:999px;
    padding:6px 10px;
  }
  #topbar button{
    border:none;
    border-radius:10px;
    padding:8px 10px;
    background:#111;
    color:#fff;
    font-weight:700;
    cursor:pointer;
  }
  #topbar button.secondary{
    background:#fff;
    color:#111;
    border:1px solid rgba(0,0,0,.15);
  }

  /* Right park checklist */
  #sidepanel{
    position:fixed;
    right:12px;
    top:12px;
    z-index:10;
    background:rgba(255,255,255,.92);
    box-shadow:0 10px 30px rgba(0,0,0,.15);
    border-radius:14px;
    padding:10px 12px;
    font-size:12px;
    width:260px;
  }
  #sidepanel h3{
    margin:0 0 8px 0;
    font-size:13px;
  }
  .parkRow{
    display:flex;
    align-items:center;
    gap:8px;
    padding:6px 0;
    border-bottom:1px solid rgba(0,0,0,.06);
  }
  .parkRow:last-child{border-bottom:none}
  .box{
    width:12px;height:12px;
    border-radius:3px;
    border:1px solid rgba(0,0,0,.25);
    display:inline-block;
  }
  .box.on{
    background:rgba(0,180,80,.95);
    border-color:rgba(0,140,60,.6);
  }

  /* Hint bubble bottom-left */
  #hint{
    position:fixed;
    left:12px;
    bottom:12px;
    z-index:10;
    background:rgba(255,255,255,.92);
    box-shadow:0 10px 30px rgba(0,0,0,.15);
    border-radius:14px;
    padding:10px 12px;
    font-size:12px;
    max-width:520px;
  }
</style>
</head>
<body>

<div id="topbar">
  <b>üêæ My Forever Dog ‚Äî Road Trip</b>
  <span class="pill">Move: Arrows / WASD</span>
  <span class="pill">Shift = run</span>
  <span class="pill">Tap dog = Pet</span>
  <button id="btnFeed" class="secondary">Feed</button>
  <button id="btnPet"  class="secondary">Pet</button>
  <button id="btnSleep" class="secondary">Sleep</button>
  <button id="btnReset" class="secondary">Reset</button>
  <span class="pill">Frames: <b id="framesLabel">6</b></span>
</div>

<div id="sidepanel">
  <h3>‚úÖ Parks visited</h3>
  <div id="parkList"></div>
</div>

<div id="hint">Loading‚Ä¶</div>

<canvas id="game"></canvas>

<script>
/* =======================================================
   CANVAS
======================================================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d", { alpha:true });

function resize(){
  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  canvas.width  = Math.floor(innerWidth  * dpr);
  canvas.height = Math.floor(innerHeight * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
addEventListener("resize", resize);
resize();

/* =======================================================
   WORLD / GROUND
======================================================= */
const WORLD_W = 2600;
const WORLD_H = 1400;
const GROUND_Y = 980;
const DOG_FOOT_OFFSET = 8;

const camera = { x:0, y:0 };
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));

/* =======================================================
   INPUT
======================================================= */
const keys = new Set();
addEventListener("keydown",(e)=>{
  const k = e.key.toLowerCase();
  keys.add(k);
  if(["arrowup","arrowdown","arrowleft","arrowright"," "].includes(k)) e.preventDefault();
},{passive:false});
addEventListener("keyup",(e)=>keys.delete(e.key.toLowerCase()));

let tap = { x:0, y:0, fired:false };
canvas.addEventListener("pointerdown",(e)=>{
  const r = canvas.getBoundingClientRect();
  tap.x = e.clientX - r.left;
  tap.y = e.clientY - r.top;
  tap.fired = true;
});

/* =======================================================
   UI
======================================================= */
const framesLabel = document.getElementById("framesLabel");
const hint = document.getElementById("hint");
const parkListEl = document.getElementById("parkList");

/* =======================================================
   SPRITE LOADING + CROPPING
======================================================= */
let FRAME_COUNT = 6;
framesLabel.textContent = FRAME_COUNT;

let sheet = null;
let frameW = 0, frameH = 0;

function loadImage(src){
  return new Promise((resolve,reject)=>{
    const im = new Image();
    im.onload = ()=>resolve(im);
    im.onerror = ()=>reject(new Error("Failed to load "+src));
    im.src = src + "?v=" + Date.now();
  });
}

// crop to visible dog pixels
function cropTransparentMargins(img){
  const w = img.naturalWidth || img.width;
  const h = img.naturalHeight || img.height;

  const off = document.createElement("canvas");
  off.width = w; off.height = h;
  const octx = off.getContext("2d", { willReadFrequently:true });
  octx.drawImage(img,0,0);

  const data = octx.getImageData(0,0,w,h).data;
  let minX=w, minY=h, maxX=0, maxY=0, found=false;

  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const a = data[(y*w + x)*4 + 3];
      if(a>5){
        found=true;
        if(x<minX)minX=x; if(y<minY)minY=y;
        if(x>maxX)maxX=x; if(y>maxY)maxY=y;
      }
    }
  }
  if(!found) return off;

  const pad=6;
  minX=Math.max(0,minX-pad); minY=Math.max(0,minY-pad);
  maxX=Math.min(w-1,maxX+pad); maxY=Math.min(h-1,maxY+pad);

  const cw=maxX-minX+1, ch=maxY-minY+1;
  const cropped=document.createElement("canvas");
  cropped.width=cw; cropped.height=ch;
  cropped.getContext("2d").drawImage(off,minX,minY,cw,ch,0,0,cw,ch);
  return cropped;
}

async function loadDogSprite(){
  // ‚úÖ This matches your repo: index.html in root, dog_walk.png in /assets/
  const img = await loadImage("assets/dog_walk.png");
  sheet = cropTransparentMargins(img);
  frameW = Math.floor(sheet.width / FRAME_COUNT);
  frameH = sheet.height;
}

/* =======================================================
   DOG
======================================================= */
const dog = {
  x: WORLD_W/2,
  y: GROUND_Y,
  vx: 0,
  vy: 0,
  facing: 1,
  frame: 0,
  animT: 0,
  speed: 320,
  runMult: 1.75,
  mood: "idle" // idle | happy | sleepy | full
};

function dogBounds(){
  if(!sheet) return {x:dog.x,y:dog.y,w:1,h:1};
  const targetH = 150;
  const scale = targetH / frameH;
  const w = frameW * scale;
  const h = frameH * scale;
  const x = dog.x - w/2;
  const y = (dog.y - h) + DOG_FOOT_OFFSET;
  return {x,y,w,h};
}

function inRect(px,py,r){ return px>=r.x && px<=r.x+r.w && py>=r.y && py<=r.y+r.h; }
function screenToWorld(sx, sy){ return { x: sx + camera.x, y: sy + camera.y }; }

/* =======================================================
   PARKS + CHECKLIST
======================================================= */
const parks = [
  { id:"yose", name:"Yosemite",      subtitle:"Half Dome",        x:520,  y:GROUND_Y-30, w:220, h:90, visited:false },
  { id:"gc",   name:"Grand Canyon",  subtitle:"South Rim View",   x:1400, y:GROUND_Y-30, w:260, h:90, visited:false },
  { id:"zion", name:"Zion",          subtitle:"Angels Landing",   x:2050, y:GROUND_Y-30, w:220, h:90, visited:false },
];

function renderParkList(){
  parkListEl.innerHTML = "";
  for(const p of parks){
    const row = document.createElement("div");
    row.className = "parkRow";
    const box = document.createElement("span");
    box.className = "box" + (p.visited ? " on" : "");
    const txt = document.createElement("div");
    txt.innerHTML = `<b>${p.name}</b> ‚Äî ${p.subtitle}`;
    row.appendChild(box);
    row.appendChild(txt);
    parkListEl.appendChild(row);
  }
}
renderParkList();

function nearestPark(){
  let best=null, bestD=1e9;
  for(const p of parks){
    const cx = p.x + p.w/2;
    const cy = p.y;
    const d = Math.hypot(dog.x - cx, dog.y - cy);
    if(d < bestD){ bestD=d; best=p; }
  }
  return (bestD < 160) ? best : null;
}

function visitPark(p){
  p.visited = true;
  renderParkList();
  dog.mood = "happy";
  hint.innerHTML = `üìç Visited <b>${p.name}</b> ‚Äî ${p.subtitle}!`;
}

/* =======================================================
   UPDATE
======================================================= */
let last = performance.now();

function update(dt){
  // tap handling
  if(tap.fired){
    tap.fired = false;
    const wpt = screenToWorld(tap.x, tap.y);

    // tap dog => pet (happy)
    if(inRect(wpt.x, wpt.y, dogBounds())){
      dog.mood = "happy";
      hint.innerHTML = "üêæ He loves that you petted him!";
    } else {
      // tap sign => visit
      for(const p of parks){
        const r = { x:p.x, y:p.y-100, w:p.w, h:p.h+140 };
        if(inRect(wpt.x, wpt.y, r)){
          visitPark(p);
          break;
        }
      }
    }
  }

  // E to visit nearest sign
  if(keys.has("e")){
    keys.delete("e");
    const p = nearestPark();
    if(p) visitPark(p);
    else hint.innerHTML = "Walk closer to a park sign, then press <b>E</b>.";
  }

  const left  = keys.has("arrowleft")  || keys.has("a");
  const right = keys.has("arrowright") || keys.has("d");
  const up    = keys.has("arrowup")    || keys.has("w");
  const down  = keys.has("arrowdown")  || keys.has("s");
  const run   = keys.has("shift");

  let ax = 0, ay = 0;
  if(left) ax -= 1;
  if(right) ax += 1;
  if(up) ay -= 1;
  if(down) ay += 1;

  const mag = Math.hypot(ax,ay) || 1;
  ax /= mag; ay /= mag;

  const spd = dog.speed * (run ? dog.runMult : 1);
  dog.vx = ax * spd;
  dog.vy = ay * spd;

  dog.x += dog.vx * dt;
  dog.y += dog.vy * dt;

  dog.x = clamp(dog.x, 60, WORLD_W-60);
  dog.y = clamp(dog.y, GROUND_Y-120, GROUND_Y+120);

  if(dog.vx > 6) dog.facing = 1;
  if(dog.vx < -6) dog.facing = -1;

  const moving = (Math.abs(dog.vx) + Math.abs(dog.vy)) > 2;

  // mood: sleepy if not moving for a while
  if(!moving){
    dog._idleT = (dog._idleT || 0) + dt;
    if(dog._idleT > 6 && dog.mood !== "sleepy"){
      dog.mood = "sleepy";
      hint.innerHTML = "üò¥ He looks sleepy. Walk him or pet him!";
    }
  } else {
    dog._idleT = 0;
  }

  // animation
  if(sheet && frameW>0 && moving){
    dog.animT += dt;
    const fps = run ? 16 : 12;
    if(dog.animT >= 1/fps){
      dog.animT = 0;
      dog.frame = (dog.frame + 1) % FRAME_COUNT;
    }
  } else {
    dog.frame = 0;
  }

  // camera follows
  camera.x = clamp(dog.x - innerWidth/2, 0, WORLD_W - innerWidth);
  camera.y = clamp(dog.y - innerHeight/2, 0, WORLD_H - innerHeight);

  const near = nearestPark();
  if(near && !near.visited){
    hint.innerHTML = `Walk up to <b>${near.name}</b> and press <b>E</b> (or tap the sign).`;
  }
}

/* =======================================================
   DRAW
======================================================= */
function draw(){
  ctx.clearRect(0,0,innerWidth,innerHeight);

  // sky
  ctx.fillStyle = "#bfe3ff";
  ctx.fillRect(0,0,innerWidth,innerHeight);

  ctx.save();
  ctx.translate(-camera.x, -camera.y);

  // soft hills
  ctx.fillStyle = "rgba(0,0,0,.06)";
  for(let i=0;i<6;i++){
    ctx.beginPath();
    ctx.ellipse(250 + i*520, 260, 520, 160, 0, 0, Math.PI*2);
    ctx.fill();
  }

  // ground
  ctx.fillStyle = "rgba(0,0,0,.10)";
  ctx.fillRect(0, GROUND_Y+40, WORLD_W, WORLD_H-(GROUND_Y+40));
  ctx.fillStyle = "rgba(255,255,255,.22)";
  ctx.fillRect(0, GROUND_Y+10, WORLD_W, 24);

  drawParks();
  drawDog();

  ctx.restore();
}

function drawParks(){
  for(const p of parks){
    const sx = p.x, sy = p.y-95, w=p.w, h=p.h;

    // post
    ctx.fillStyle = "rgba(0,0,0,.20)";
    ctx.fillRect(sx + w/2 - 8, sy + h, 16, 70);
    // shadow
    ctx.fillStyle = "rgba(0,0,0,.08)";
    ctx.fillRect(sx + w/2 - 28, sy + h + 62, 56, 10);

    // board
    ctx.fillStyle = "rgba(255,255,255,.92)";
    roundRect(ctx, sx, sy, w, h, 14, true, false);

    ctx.strokeStyle = p.visited ? "rgba(0,160,80,.55)" : "rgba(0,0,0,.16)";
    ctx.lineWidth = 2;
    roundRect(ctx, sx, sy, w, h, 14, false, true);

    ctx.fillStyle = "rgba(0,0,0,.78)";
    ctx.font = "700 16px system-ui";
    ctx.fillText(p.name, sx+12, sy+28);
    ctx.font = "12px system-ui";
    ctx.fillText(p.subtitle, sx+12, sy+50);
  }
}

function drawDog(){
  const px = dog.x;
  const py = dog.y;

  if(!sheet || frameW<=0){
    ctx.fillStyle = "rgba(0,0,0,.35)";
    ctx.beginPath(); ctx.arc(px, py, 26, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "#fff";
    ctx.fillText("loading assets/dog_walk.png...", px-90, py-40);
    return;
  }

  const targetH = 150;
  const scale = targetH / frameH;
  const drawW = frameW * scale;
  const drawH = frameH * scale;

  const dx = px - drawW/2;
  const dy = (py - drawH) + DOG_FOOT_OFFSET;

  const sx = dog.frame * frameW;
  const sy = 0;

  ctx.save();
  if(dog.facing === -1){
    ctx.translate(px, 0);
    ctx.scale(-1, 1);
    ctx.translate(-px, 0);
  }
  ctx.imageSmoothingEnabled = true;
  ctx.drawImage(sheet, sx, sy, frameW, frameH, dx, dy, drawW, drawH);
  ctx.restore();

  // little speech bubble based on mood
  ctx.font = "11px system-ui";
  if(dog.mood === "happy"){
    ctx.fillStyle = "rgba(255,255,255,.85)";
    roundRect(ctx, px-34, dy-44, 80, 26, 999, true, false);
    ctx.fillStyle = "rgba(0,0,0,.70)";
    ctx.fillText("so happy!", px-18, dy-26);
  }else if(dog.mood === "sleepy"){
    ctx.fillStyle = "rgba(255,255,255,.85)";
    roundRect(ctx, px-20, dy-44, 50, 26, 999, true, false);
    ctx.fillStyle = "rgba(0,0,0,.70)";
    ctx.fillText("zzz‚Ä¶", px-5, dy-26);
  }
}

/* =======================================================
   LOOP
======================================================= */
function loop(now){
  const dt = Math.min(0.033, (now - last)/1000);
  last = now;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}

/* =======================================================
   BUTTONS: Feed / Pet / Sleep / Reset
======================================================= */
document.getElementById("btnFeed").addEventListener("click", ()=>{
  dog.mood = "full";
  hint.innerHTML = "üçñ You fed him a snack. Yum!";
});
document.getElementById("btnPet").addEventListener("click", ()=>{
  dog.mood = "happy";
  hint.innerHTML = "üêæ He loves pets!";
});
document.getElementById("btnSleep").addEventListener("click", ()=>{
  dog.mood = "sleepy";
  hint.innerHTML = "üò¥ He curls up for a quick nap.";
});
document.getElementById("btnReset").addEventListener("click", ()=>{
  dog.x = WORLD_W/2;
  dog.y = GROUND_Y;
  dog.vx = dog.vy = 0;
  dog.facing = 1;
  dog.frame = 0;
  dog.mood = "idle";
  for(const p of parks) p.visited = false;
  renderParkList();
  hint.innerHTML = "Reset! Walk to a sign and press E or tap it.";
});

/* =======================================================
   START
======================================================= */
(async function start(){
  try{
    hint.textContent = "Loading dog sprite‚Ä¶";
    await loadDogSprite();
    hint.innerHTML = "‚úÖ Loaded! Use arrows/WASD to walk. Tap dog to pet. Press E at signs.";
    requestAnimationFrame(loop);
  }catch(err){
    console.error(err);
    hint.textContent = "‚ùå Could not load assets/dog_walk.png. Check the filename in /assets.";
  }
})();
</script>
</body>
</html>
