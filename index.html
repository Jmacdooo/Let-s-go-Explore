<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Forever Dog ‚Äî Calm, Connect & Reset</title>
  <style>
    body{
      margin:0;
      background:#bde0fe;
      overflow:hidden;
      font-family: system-ui, -apple-system, sans-serif;
    }
    canvas{
      display:block;
      width:100vw;
      height:100vh;
    }
    #controls{
      position:fixed;
      left:10px;
      top:10px;
      z-index:10;
      background:rgba(255,255,255,.9);
      padding:8px 10px;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,.2);
    }
    button{
      padding:8px 10px;
      margin:2px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:600;
      background:#ffb703;
    }
    #msg{
      position:fixed;
      left:50%;
      bottom:12px;
      transform:translateX(-50%);
      background:rgba(255,255,255,.95);
      padding:8px 14px;
      border-radius:14px;
      box-shadow:0 4px 12px rgba(0,0,0,.2);
      font-size:14px;
      max-width:90vw;
      text-align:center;
    }
  </style>
</head>

<body>
  <div id="controls">
    <button id="leftBtn">‚¨Ö Walk</button>
    <button id="stopBtn">‚è∏ Stop</button>
    <button id="rightBtn">Walk ‚û°</button>
    <button id="petBtn">‚ù§Ô∏è Pet</button>
    <button id="feedBtn">üçñ Feed</button>
  </div>

  <div id="msg">Take a calm walk with Parks and let your body reset as you visit beautiful national parks.</div>
  <canvas id="game"></canvas>

  <!-- =========================================================
       SCRIPT BELOW ‚Äî CALM PUPPY RESET VERSION
       ========================================================= -->
  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const msgEl = document.getElementById("msg");

    function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener("resize", resize); resize();

    function dogGroundY(){ return canvas.height - 70; }
    function signGroundY(){ return canvas.height - 150; }

    const DOG_BODY_SCREEN_HEIGHT = 320;
    const WALK_FRAMES = 5;

    let barkSound = null;
    try { barkSound = new Audio("assets/bark.mp3"); } catch(e) { console.warn("bark.mp3 not found"); }
    function playBark(){ if(!barkSound) return; barkSound.currentTime=0; barkSound.play().catch(()=>{}); }

    const bgImage = new Image();
    bgImage.src = "assets/yosemite.png";

    /* üå≤ NEW CALM + RESET PARKS */
    const parks = [
      {
        id:"half_dome", name:"Half Dome", subtitle:"Yosemite", pos:0.30, visited:false,
        guideLine:"Half Dome is a giant granite rock in Yosemite National Park.",
        dogLine:"Let‚Äôs slow our steps and look up at Half Dome. Big strong rocks can remind our bodies to feel steady and safe."
      },
      {
        id:"yose_falls", name:"Yosemite Falls", subtitle:"Upper & Lower Falls", pos:0.60, visited:false,
        guideLine:"Yosemite Falls is one of the tallest waterfalls in North America.",
        dogLine:"Imagine you can hear the waterfall. Breathe in like cool mist on your face‚Ä¶ and blow the air out slowly like the water flowing down."
      },
      {
        id:"tunnel_view", name:"Tunnel View", subtitle:"Lookout", pos:0.90, visited:false,
        guideLine:"Tunnel View shows Half Dome, El Capitan, and Bridalveil Fall all together.",
        dogLine:"Tunnel View is like a giant picture window. Let‚Äôs pause here, take three soft breaths, and notice all the shapes and colors."
      }
    ];

    const images = {}, meta = {};
    function loadSprite(state, file, frames){ const img=new Image(); img.src="assets/"+file; img.onload=()=>analyze(state,img,frames); images[state]=img; }
    function analyze(state,img,frames){
      const frameW=img.width/frames, frameH=img.height;
      const off=document.createElement("canvas"); off.width=frameW; off.height=frameH;
      const octx=off.getContext("2d"); octx.drawImage(img,0,0);
      const data=octx.getImageData(0,0,frameW,frameH).data;
      let top=frameH,bottom=-1;
      for(let y=0;y<frameH;y++){ for(let x=0;x<frameW;x++){ const a=data[(y*frameW+x)*4+3]; if(a>10){ if(y<top)top=y; if(y>bottom)bottom=y; } } }
      if(bottom===-1){ meta[state]={frameW,frameH,contentHeight:frameH,bottomMargin:0}; return; }
      const contentHeight=bottom-top+1, bottomMargin=(frameH-1)-bottom;
      meta[state]={frameW,frameH,contentHeight,bottomMargin};
    }
    loadSprite("walk","dog_walk.png",WALK_FRAMES);
    loadSprite("idle","dog_idle.png",1);

    let guideVoice=null,dogVoice=null;
    function initVoices(){
      if(!("speechSynthesis"in window))return;
      const v=window.speechSynthesis.getVoices(); if(!v.length)return;
      guideVoice=v.find(x=>/Google UK English Female|US English|en/i.test(x.name))||v[0];
      dogVoice=v.find(x=>x!==guideVoice&&x.lang.startsWith("en"))||guideVoice;
    }
    if("speechSynthesis"in window){ speechSynthesis.onvoiceschanged=initVoices; initVoices(); }

    /* üê∂ RELAXATION SPEECH ONLY */
    function speakForLandmark(p){
      const text=(p.dogLine||"")+" "+(p.guideLine||"");
      showMsg(text);
      if(!("speechSynthesis"in window))return;
      const u=new SpeechSynthesisUtterance(text);
      u.voice=dogVoice||guideVoice; u.rate=0.95; u.pitch=1.2;
      speechSynthesis.cancel(); speechSynthesis.speak(u);
    }

    const dog={ x:canvas.width*0.15, dir:1, speed:7, state:"idle", frame:0 };
    let left=false,right=false;

    const L=document.getElementById("leftBtn"),R=document.getElementById("rightBtn"),S=document.getElementById("stopBtn"),P=document.getElementById("petBtn"),F=document.getElementById("feedBtn");

    function stop(){ left=right=false; dog.state="idle"; }

    /* üö∂ Walking = calm prompt */
    function calmWalk(){
      showMsg("Let‚Äôs take a gentle walk and reset together. We can slow our bodies down as we look at the beautiful national parks.");
      if("speechSynthesis"in window)speechSynthesis.cancel();
    }

    L.onclick=()=>{ left=true; right=false; dog.dir=-1; dog.state="walk"; calmWalk(); };
    R.onclick=()=>{ right=true; left=false; dog.dir=1; dog.state="walk"; calmWalk(); };
    S.onclick=()=>{ stop(); if("speechSynthesis"in window)speechSynthesis.cancel(); };

    P.onclick=()=>{ stop(); playBark(); showMsg("Your dog loves gentle pets. Taking time to pause and cuddle can help our bodies feel safe. ‚ù§Ô∏è"); };
    F.onclick=()=>{ stop(); playBark(); showMsg("Snack time! Even Parks takes breaks to rest and refuel. üçñ"); };

    window.addEventListener("keydown",e=>{
      if(e.key==="ArrowLeft")L.onclick();
      if(e.key==="ArrowRight")R.onclick();
      if(e.key===" ")S.onclick();
    });

    let msgTimer=0;
    function showMsg(t){ msgEl.textContent=t; msgTimer=240; }

    function update(){
      if(dog.state==="walk"){ if(left)dog.x-=dog.speed; if(right)dog.x+=dog.speed; }
      dog.x=Math.max(60,Math.min(canvas.width-60,dog.x));
      const center=dog.x;
      parks.forEach(p=>{ const px=p.pos*canvas.width;
        if(!p.visited && Math.abs(center-px)<45 && dog.state==="walk"){
          stop(); p.visited=true; speakForLandmark(p);
        }
      });
      if(msgTimer>0 && --msgTimer===0){
        msgEl.textContent="Take a calm walk with Parks and let your body reset as you visit beautiful national parks.";
      }
      dog.frame++;
    }

    function drawBG(){
      if(bgImage.complete&&bgImage.naturalWidth>0){
        const iw=bgImage.naturalWidth, ih=bgImage.naturalHeight;
        const sc=Math.max(canvas.width/iw,canvas.height/ih);
        ctx.drawImage(bgImage,(canvas.width-iw*sc)/2,(canvas.height-ih*sc)/2,iw*sc,ih*sc);
      } else { ctx.fillStyle="#bde0fe"; ctx.fillRect(0,0,canvas.width,canvas.height); }
      ctx.fillStyle="#90e0ef"; ctx.fillRect(0,dogGroundY(),canvas.width,canvas.height-dogGroundY());
    }

    function drawSigns(){
      const sg=signGroundY();
      parks.forEach(p=>{
        const x=p.pos*canvas.width, top=sg-120;
        ctx.fillStyle="rgba(0,0,0,.35)"; ctx.fillRect(x-3,top+20,6,100);
        ctx.fillStyle="rgba(255,255,255,.96)"; ctx.fillRect(x-90,top,180,44);
        ctx.fillStyle="#000"; ctx.font="15px system-ui"; ctx.fillText(p.name, x-80,top+14);
        ctx.font="12px system-ui"; ctx.fillText(p.subtitle,x-80,top+30);
        ctx.fillStyle=p.visited?"#2a9d8f":"#e76f51"; ctx.beginPath(); ctx.arc(x+70,top+22,7,0,Math.PI*2); ctx.fill();
      });
    }

    function drawDog(){
      const s=dog.state==="walk"?"walk":"idle", img=images[s], m=meta[s];
      if(!img||!m)return;
      const f=(s==="walk"?WALK_FRAMES:1), w=m.frameW, h=m.frameH, ch=m.contentHeight, bm=m.bottomMargin;
      const scale=DOG_BODY_SCREEN_HEIGHT/ch, dw=w*scale, dh=h*scale, bms=bm*scale;
      let fi=0; if(s==="walk"&&f>1) fi=Math.floor(dog.frame/6)%f;
      const sx=fi*w, dx=dog.x-dw/2, dy=dogGroundY()-(dh-bms);
      ctx.save();
      if(dog.dir<0){ ctx.scale(-1,1); ctx.drawImage(img,sx,0,w,h,-dx-dw,dy,dw,dh); }
      else ctx.drawImage(img,sx,0,w,h,dx,dy,dw,dh);
      ctx.restore();
    }

    function loop(){ update(); ctx.clearRect(0,0,canvas.width,canvas.height); drawBG(); drawSigns(); drawDog(); requestAnimationFrame(loop); }
    loop();
  </script>
</body>
</html>
