<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calm Dog v8 — Transition Walk + Baby Shapes + Music</title>
  <style>
    html,body{margin:0;height:100%;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif;background:#eaf4ff;}
    canvas{display:block;width:100vw;height:100vh;}

    #banner{
      position:fixed;left:50%;top:10px;transform:translateX(-50%);
      z-index:20;font-weight:1000;letter-spacing:.4px;
      background:rgba(0,0,0,.70);color:#fff;padding:8px 12px;border-radius:999px;
      box-shadow:0 10px 30px rgba(0,0,0,.20);
    }

    #hud{
      position:fixed;left:12px;top:12px;z-index:21;
      background:rgba(255,255,255,.92);box-shadow:0 10px 30px rgba(0,0,0,.18);
      padding:10px 12px;border-radius:16px;user-select:none;
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
    }
    .btn{border:none;border-radius:14px;padding:10px 12px;font-weight:900;cursor:pointer;background:#ffd166;}
    .btn.secondary{background:#e9ecef;}

    #hint{
      position:fixed;left:50%;bottom:14px;transform:translateX(-50%);
      background:rgba(255,255,255,.92);box-shadow:0 10px 30px rgba(0,0,0,.18);
      padding:10px 14px;border-radius:16px;
      font-weight:900;text-align:center;max-width:min(920px, calc(100vw - 24px));
      z-index:21;line-height:1.25;
    }
    #hint small{display:block;font-weight:800;opacity:.75;margin-top:4px;}

    #errorBanner{
      position:fixed;left:12px;right:12px;top:78px;z-index:9999;
      background:rgba(180,0,0,.92);color:#fff;
      padding:12px 14px;border-radius:14px;
      font-weight:800;display:none;white-space:pre-wrap;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
  </style>
</head>
<body>

  <div id="banner">CALM DOG v8 ✅</div>

  <div id="hud">
    <button class="btn" id="startBtn">Start</button>
    <button class="btn secondary" id="restartBtn">Restart</button>
    <button class="btn secondary" id="voiceBtn">Voice: ON</button>
    <button class="btn secondary" id="musicBtn">Music: OFF</button>
  </div>

  <div id="hint">
    Ready to be calm and go for a walk?
    <small>Tap Start (or tap anywhere) to begin.</small>
  </div>

  <div id="errorBanner"></div>
  <canvas id="c"></canvas>

<script>
(() => {
  const errorBanner = document.getElementById("errorBanner");
  const showError = (msg) => {
    errorBanner.style.display = "block";
    errorBanner.textContent = String(msg);
  };
  window.addEventListener("error", (e)=>showError("JS Error:\n" + (e.error?.stack || e.message || e)));
  window.addEventListener("unhandledrejection", (e)=>showError("Promise Error:\n" + (e.reason?.stack || e.reason || e)));

  // ---------- CALM SETTINGS ----------
  const PHASE_MS = 4200;                 // slower inhale/exhale
  const SCALE_MIN = 0.62;
  const SCALE_MAX = 2.10;

  // Drop dog lower during breathing so it won't cover numbers:
  const BREATH_DOG_DROP_BASE = 70;
  const BREATH_DOG_DROP_PER_SCALE = 55;
  const BREATH_DOG_DROP_MAX = 170;

  // Transition walk (walk off screen)
  const EXIT_MARGIN = 220;               // how far off screen before reset
  const TRANSITION_SPEED_MULT = 0.75;    // how fast the dog exits

  // Exploration grace time (ignore landmarks briefly right at start)
  const EXPLORE_GRACE_MS = 1200;
  // -------------------------------

  // ---------- OPTIONAL ASSETS ----------
  // ./assets/yosemite.png
  // ./assets/dog_idle.png
  // ./assets/dog_walk.png
  // ./assets/music.mp3
  const ASSETS = {
    bg:    "./assets/yosemite.png",
    idle:  "./assets/dog_idle.png",
    walk:  "./assets/dog_walk.png",
    music: "./assets/music.mp3"
  };
  const WALK_FRAMES = 5; // set to 6 if your strip has 6 frames
  // ------------------------------------

  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");

  const hint = document.getElementById("hint");
  const startBtn = document.getElementById("startBtn");
  const restartBtn = document.getElementById("restartBtn");
  const voiceBtn = document.getElementById("voiceBtn");
  const musicBtn = document.getElementById("musicBtn");

  function resize(){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    canvas.width  = Math.floor(window.innerWidth  * dpr);
    canvas.height = Math.floor(window.innerHeight * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener("resize", resize);
  resize();

  // ---------- Safe image load ----------
  const loadImage = (src) => new Promise((resolve)=>{
    const img = new Image();
    img.onload = ()=>resolve(img);
    img.onerror = ()=>resolve(null);
    img.src = src;
  });

  let bgImg=null, idleImg=null, walkImg=null;
  (async ()=>{
    [bgImg, idleImg, walkImg] = await Promise.all([
      loadImage(ASSETS.bg),
      loadImage(ASSETS.idle),
      loadImage(ASSETS.walk),
    ]);
  })();

  // ---------- Music (starts only after user gesture) ----------
  const bgm = new Audio();
  bgm.src = ASSETS.music;
  bgm.loop = true;
  bgm.volume = 0.25;

  let musicOn = false;
  async function setMusic(on){
    musicOn = on;
    musicBtn.textContent = musicOn ? "Music: ON" : "Music: OFF";
    try{
      if (!musicOn){
        bgm.pause();
      } else {
        await bgm.play();
      }
    }catch(e){
      // If autoplay is blocked, it'll work after another tap.
    }
  }
  musicBtn.addEventListener("click", ()=>setMusic(!musicOn));

  // ---------- Voice (child-like, sequential safe) ----------
  const hasSpeech = ("speechSynthesis" in window) && ("SpeechSynthesisUtterance" in window);
  const VOICE = { on:true, voice:null, rate:0.88, pitch:2.25 };

  function pickVoice(){
    if (!hasSpeech) return;
    const vs = speechSynthesis.getVoices?.() || [];
    const en = vs.filter(v => /en/i.test(v.lang));
    VOICE.voice =
      en.find(v => /(Google US English|Samantha|Ava|Aria|Jenny|Allison|Zira)/i.test(v.name)) ||
      en.find(v => /Google/i.test(v.name)) ||
      en[0] || vs[0] || null;
  }
  if (hasSpeech){
    speechSynthesis.onvoiceschanged = pickVoice;
    pickVoice();
  }

  function cancelSpeech(){
    if (!hasSpeech) return;
    try{ speechSynthesis.cancel(); }catch(e){}
  }

  function sayAsync(text, { interrupt=false } = {}){
    return new Promise((resolve)=>{
      if (!VOICE.on || !hasSpeech){
        resolve(); return;
      }
      if (interrupt) cancelSpeech();

      const u = new SpeechSynthesisUtterance(String(text));
      if (VOICE.voice) u.voice = VOICE.voice;
      u.rate = VOICE.rate;
      u.pitch = VOICE.pitch;
      u.volume = 1.0;

      let done = false;
      const finish = () => {
        if (done) return;
        done = true;
        resolve();
      };
      u.onend = finish;
      u.onerror = finish;

      try{ speechSynthesis.speak(u); }
      catch(e){ finish(); }

      setTimeout(finish, 8000);
    });
  }

  voiceBtn.addEventListener("click", ()=>{
    VOICE.on = !VOICE.on;
    voiceBtn.textContent = VOICE.on ? "Voice: ON" : "Voice: OFF";
    if (!VOICE.on) cancelSpeech();
  });

  // ---------- Baby-proof input (hold left/right half of screen) ----------
  let left=false, right=false;
  window.addEventListener("keydown", (e)=>{ if(e.key==="ArrowLeft")left=true; if(e.key==="ArrowRight")right=true; });
  window.addEventListener("keyup", (e)=>{ if(e.key==="ArrowLeft")left=false; if(e.key==="ArrowRight")right=false; });

  function handlePointer(e, isDown){
    const x = e.clientX;
    if (!isDown){ left=false; right=false; return; }
    if (x < window.innerWidth/2){ left=true; right=false; }
    else { right=true; left=false; }
  }
  window.addEventListener("pointerdown", (e)=>handlePointer(e,true));
  window.addEventListener("pointermove", (e)=>{ if(e.buttons) handlePointer(e,true); });
  window.addEventListener("pointerup",   (e)=>handlePointer(e,false));
  window.addEventListener("pointercancel",(e)=>handlePointer(e,false));

  // ---------- Baby shapes landmarks ----------
  const parks = [
    { name:"Circle",   pos:0.18, visited:false, icon:"●" },
    { name:"Square",   pos:0.36, visited:false, icon:"■" },
    { name:"Triangle", pos:0.54, visited:false, icon:"▲" },
    { name:"Star",     pos:0.72, visited:false, icon:"★" },
    { name:"Heart",    pos:0.88, visited:false, icon:"♥" },
  ];

  // ---------- State ----------
  const MODE = { INTRO:"intro", OPENING:"opening", BREATH:"breath", TRANSITION:"transition",
