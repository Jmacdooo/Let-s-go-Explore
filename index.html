<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>My Forever Dog ‚Äî National Parks Road Trip</title>
<style>
  :root { --panel: rgba(255,255,255,.90); --shadow: 0 10px 30px rgba(0,0,0,.15); }
  body { margin:0; overflow:hidden; background:#dff2ff; font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif; }
  canvas { display:block; width:100vw; height:100vh; }

  #topbar {
    position: fixed; left: 12px; top: 12px;
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    background: var(--panel);
    padding:10px 12px; border-radius:14px; box-shadow: var(--shadow);
    z-index: 10;
  }
  .btn {
    padding:10px 12px; border-radius:12px; border:none; cursor:pointer;
    background:#ffb703; font-weight:700;
  }
  .btn.secondary { background:#90e0ef; }
  .btn.ghost { background:#eee; }
  .btn:active { transform: translateY(1px); }

  #hud {
    position: fixed; right: 12px; top: 12px;
    width: 320px; max-width: calc(100vw - 24px);
    background: var(--panel); padding: 12px; border-radius: 14px; box-shadow: var(--shadow);
    z-index: 10;
  }
  #hud h3 { margin:0 0 6px 0; font-size: 16px; }
  #hud small { color:#333; }
  #progress { margin-top: 8px; font-size: 13px; line-height: 1.35; max-height: 210px; overflow:auto; }

  #toast {
    position: fixed; left: 50%; bottom: 16px; transform: translateX(-50%);
    background: rgba(255,255,255,.92);
    padding: 10px 14px; border-radius: 14px; box-shadow: var(--shadow);
    font-weight: 700;
    opacity: 0; transition: opacity .2s ease;
    z-index: 10;
    max-width: calc(100vw - 28px);
    white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
  }
  #toast.show { opacity: 1; }

  .panelOverlay {
    position: fixed; inset: 0; background: rgba(0,0,0,.35);
    display:none; align-items:center; justify-content:center;
    z-index: 20;
    padding: 14px;
  }
  .panelOverlay.show { display:flex; }
  .panel {
    width: min(980px, 100%);
    background: rgba(255,255,255,.95);
    border-radius: 18px;
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .panelHeader {
    display:flex; align-items:center; justify-content:space-between;
    padding: 12px 14px;
    background: #f6f7fb;
    border-bottom: 1px solid rgba(0,0,0,.08);
  }
  .panelHeader h2 { margin:0; font-size: 18px; }
  .panelBody { padding: 12px 14px; }

  .grid {
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px;
  }
  .card {
    background: #fff;
    border-radius: 16px;
    overflow:hidden;
    box-shadow: 0 10px 25px rgba(0,0,0,.10);
    cursor:pointer;
    border: 2px solid transparent;
  }
  .card:hover { border-color: rgba(0,0,0,.08); }
  .thumb {
    height: 110px;
    background: linear-gradient(135deg, rgba(144,224,239,.9), rgba(255,183,3,.35));
    display:flex; align-items:center; justify-content:center;
    font-size: 32px;
  }
  .meta { padding: 10px 12px; }
  .meta b { display:block; font-size: 14px; }
  .meta span { font-size: 12px; color:#333; }
  .badge { display:inline-flex; gap:6px; align-items:center; margin-top:6px; font-size: 12px; }
  .pill { padding: 4px 8px; background:#f2f2f2; border-radius: 999px; font-weight:700; }

  .passportGrid {
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 10px;
  }
  .stamp {
    border-radius: 14px;
    padding: 10px 12px;
    background: #fff;
    box-shadow: 0 8px 20px rgba(0,0,0,.08);
    border: 2px dashed rgba(0,0,0,.15);
  }
  .stamp .row { display:flex; justify-content:space-between; align-items:center; }
  .stamp b { font-size: 13px; }
  .stamp small { color:#333; }
  .stamp .big { font-size: 22px; margin-top: 6px; }

  @media (max-width: 520px) {
    #hud { width: 280px; }
    .btn { padding: 10px 10px; }
  }
</style>
</head>

<body>
<canvas id="game"></canvas>

<div id="topbar">
  <button class="btn" id="leftBtn">‚¨Ö Walk</button>
  <button class="btn ghost" id="stopBtn">‚è∏ Stop</button>
  <button class="btn" id="rightBtn">Walk ‚û°</button>
  <button class="btn secondary" id="petBtn">‚ù§Ô∏è Pet</button>
  <button class="btn secondary" id="feedBtn">üçñ Feed</button>
  <button class="btn" id="mapBtn">üó∫ Park Map</button>
  <button class="btn" id="passportBtn">üìò Passport</button>
  <button class="btn ghost" id="soundBtn">üîä Sound: Off</button>
</div>

<div id="hud">
  <h3>Road Trip Progress: <span id="count">0</span>/10</h3>
  <small>Walk to landmarks or use the map to travel.</small>
  <div id="progress"></div>
</div>

<div id="toast"></div>

<div class="panelOverlay" id="mapOverlay">
  <div class="panel">
    <div class="panelHeader">
      <h2>üó∫ National Parks Map</h2>
      <button class="btn ghost" id="closeMapBtn">Close</button>
    </div>
    <div class="panelBody">
      <div class="grid" id="mapGrid"></div>
    </div>
  </div>
</div>

<div class="panelOverlay" id="passportOverlay">
  <div class="panel">
    <div class="panelHeader">
      <h2>üìò Road Trip Passport</h2>
      <button class="btn ghost" id="closePassportBtn">Close</button>
    </div>
    <div class="panelBody">
      <div class="passportGrid" id="passportGrid"></div>
    </div>
  </div>
</div>

<script>
/* =========================================================
   MY FOREVER DOG ‚Äî NATIONAL PARKS ROAD TRIP (CLEAN BUILD)
   ‚úÖ Uses your PNGs in /assets/
      - assets/dog_idle.png
      - assets/dog_walk.png  (HORIZONTAL STRIP, faces RIGHT)
      - assets/dog_eat.png
      - assets/dog_paw.png   (optional)
      - assets/dog_sleep.png (optional)
   ‚úÖ Smooth acceleration (no sliding)
   ‚úÖ Footstep sound sync (toggle)
   ‚úÖ No duplicate functions / no syntax landmines
   ========================================================= */

// ---------- Canvas sizing ----------
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = Math.floor(window.innerWidth * devicePixelRatio);
  canvas.height = Math.floor(window.innerHeight * devicePixelRatio);
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
window.addEventListener("resize", resize);
resize();

// ---------- Helpers ----------
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const dist  = (x1,y1,x2,y2)=>Math.hypot(x1-x2,y1-y2);

// ---------- World ----------
const WORLD_W = 5200;
const WORLD_H = 1400;
const PATH_Y  = 860;

// Camera follows dog
const camera = { x: 0, y: 0 };
function centerCameraOn(wx, wy){
  camera.x = clamp(wx - window.innerWidth/2, 0, WORLD_W - window.innerWidth);
  camera.y = clamp(wy - window.innerHeight/2, 0, WORLD_H - window.innerHeight);
}

// ---------- Assets ----------
const ASSET_BASE = "assets/"; // <-- IMPORTANT: your screenshot shows dog PNGs in /assets/ (not /assets/dog/)
window.images = window.images || {};
const images = window.images;

function loadImage(key, src){
  return new Promise((resolve) => {
    const img = new Image();
    img.onload  = ()=>{ images[key]=img; resolve(true); };
    img.onerror = ()=>{ resolve(false); };
    img.src = src;
  });
}

// Load what you actually have
(async function loadAssets(){
  await loadImage("dog_idle",  ASSET_BASE + "dog_idle.png");
  await loadImage("dog_walk",  ASSET_BASE + "dog_walk.png");
  await loadImage("dog_eat",   ASSET_BASE + "dog_eat.png");
  await loadImage("dog_paw",   ASSET_BASE + "dog_paw.png");   // optional
  await loadImage("dog_sleep", ASSET_BASE + "dog_sleep.png"); // optional

  // If optional ones missing, reuse idle so we never draw blank
  if(!images["dog_paw"])   images["dog_paw"]   = images["dog_idle"] || null;
  if(!images["dog_sleep"]) images["dog_sleep"] = images["dog_idle"] || null;

  toast("üê∂ Assets loaded! Use Walk buttons (or arrow keys). Tap animals!");
})();

// ---------- Parks / Landmarks (10) ----------
const parks = [
  { id:"yosemite", name:"Yosemite", subtitle:"Half Dome", emoji:"‚õ∞Ô∏è", x: 320,  y: PATH_Y,  animal:{ name:"Black Bear", emoji:"üêª", message:"A bear sniffs the air‚Ä¶ your dog stays calm. Good pup!" } },
  { id:"grandcanyon", name:"Grand Canyon", subtitle:"South Rim View", emoji:"üß°", x: 820,  y: PATH_Y,  animal:{ name:"Condor", emoji:"ü¶Ö", message:"A condor glides overhead. Your dog looks up like: wow!" } },
  { id:"zion", name:"Zion", subtitle:"Angels Landing", emoji:"ü™®", x: 1320, y: PATH_Y,  animal:{ name:"Bighorn Sheep", emoji:"üêè", message:"A bighorn sheep poses for a photo. Your dog wags politely." } },
  { id:"arches", name:"Arches", subtitle:"Delicate Arch", emoji:"üåÖ", x: 1820, y: PATH_Y,  animal:{ name:"Desert Fox", emoji:"ü¶ä", message:"A fox darts by! Your dog freezes‚Ä¶ then smiles." } },
  { id:"yellowstone", name:"Yellowstone", subtitle:"Old Faithful", emoji:"üí¶", x: 2320, y: PATH_Y, animal:{ name:"Bison", emoji:"ü¶¨", message:"A bison is nearby. Your dog keeps a respectful distance. Smart!" } },
  { id:"tetons", name:"Grand Teton", subtitle:"Teton Range", emoji:"üèîÔ∏è", x: 2820, y: PATH_Y,  animal:{ name:"Moose", emoji:"ü´é", message:"A moose munches leaves. Your dog is amazed (and quiet)." } },
  { id:"glacier", name:"Glacier", subtitle:"Going-to-the-Sun Road", emoji:"‚ùÑÔ∏è", x: 3320, y: PATH_Y, animal:{ name:"Mountain Goat", emoji:"üêê", message:"A mountain goat climbs like a superhero." } },
  { id:"rockymtn", name:"Rocky Mountain", subtitle:"Trail Ridge Road", emoji:"üå≤", x: 3820, y: PATH_Y, animal:{ name:"Elk", emoji:"ü¶å", message:"An elk bugles! Your dog tilts head: ‚ÄòWhat was THAT?‚Äô" } },
  { id:"acadia", name:"Acadia", subtitle:"Cadillac Mountain", emoji:"üåä", x: 4320, y: PATH_Y, animal:{ name:"Harbor Seal", emoji:"ü¶≠", message:"A seal pops up and splashes. Your dog is delighted." } },
  { id:"everglades", name:"Everglades", subtitle:"Alligator Alley", emoji:"üêä", x: 4820, y: PATH_Y, animal:{ name:"Alligator", emoji:"üêä", message:"You spot an alligator (from far away!). Your dog stays safe." } },
];

const discovered = new Set();

// ---------- Dog (physics + animation) ----------
const dog = {
  x: 240,
  y: PATH_Y + 78,         // <-- dog "feet line" anchor (we draw sprite ABOVE this)
  vx: 0,
  w: 80,                  // logical box (not sprite size)
  h: 60,
  dir: 1,                 // 1 = right, -1 = left
  state: "idle",          // idle | walk | happy | eat | paw | sleep | travel
  timer: 0,
  animTime: 0,
};

// Smooth motion
const MOVE = {
  accel: 0.55,
  maxV:  5.2,
  friction: 0.82
};

// ---------- Controls ----------
let moveLeft=false, moveRight=false;

const leftBtn = document.getElementById("leftBtn");
const rightBtn = document.getElementById("rightBtn");
const stopBtn = document.getElementById("stopBtn");
const petBtn = document.getElementById("petBtn");
const feedBtn = document.getElementById("feedBtn");
const mapBtn = document.getElementById("mapBtn");
const passportBtn = document.getElementById("passportBtn");
const soundBtn = document.getElementById("soundBtn");

leftBtn.onclick  = ()=>{ moveLeft=true;  moveRight=false; dog.dir=-1; dog.state="walk"; };
rightBtn.onclick = ()=>{ moveRight=true; moveLeft=false;  dog.dir= 1; dog.state="walk"; };
stopBtn.onclick  = ()=>{ moveLeft=false; moveRight=false; };
petBtn.onclick   = ()=>setDogMood("happy",  120, "‚ù§Ô∏è Your dog feels loved!");
feedBtn.onclick  = ()=>setDogMood("eat",    140, "üçñ Yum! Happy dog energy!");

window.addEventListener("keydown",(e)=>{
  if(e.key==="ArrowLeft")  leftBtn.onclick();
  if(e.key==="ArrowRight") rightBtn.onclick();
  if(e.key===" ")          stopBtn.onclick();
  if(e.key.toLowerCase()==="m") openMap();
  if(e.key.toLowerCase()==="p") openPassport();
  if(e.key.toLowerCase()==="f") feedBtn.onclick();
  if(e.key.toLowerCase()==="s") toggleSound();
});
window.addEventListener("keyup",(e)=>{
  if(e.key==="ArrowLeft")  moveLeft=false;
  if(e.key==="ArrowRight") moveRight=false;
});

// ---------- Toast ----------
const toastEl = document.getElementById("toast");
let toastT = 0;
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  toastT = 200;
}

// ---------- Panels ----------
const mapOverlay = document.getElementById("mapOverlay");
const passportOverlay = document.getElementById("passportOverlay");
document.getElementById("closeMapBtn").onclick      = ()=>mapOverlay.classList.remove("show");
document.getElementById("closePassportBtn").onclick = ()=>passportOverlay.classList.remove("show");
mapOverlay.addEventListener("click",(e)=>{ if(e.target===mapOverlay) mapOverlay.classList.remove("show"); });
passportOverlay.addEventListener("click",(e)=>{ if(e.target===passportOverlay) passportOverlay.classList.remove("show"); });
function openMap(){ buildMap(); mapOverlay.classList.add("show"); }
function openPassport(){ buildPassport(); passportOverlay.classList.add("show"); }
mapBtn.onclick = openMap;
passportBtn.onclick = openPassport;

// ---------- HUD ----------
const countEl = document.getElementById("count");
const progressEl = document.getElementById("progress");
function renderHUD(){
  countEl.textContent = discovered.size;
  progressEl.innerHTML = parks.map(p=>{
    const ok = discovered.has(p.id);
    return `${ok?"‚úÖ":"‚¨ú"} <b>${p.name}</b> ‚Äî ${p.subtitle}`;
  }).join("<br/>");
}
renderHUD();

// ---------- Map builder ----------
function buildMap(){
  const grid = document.getElementById("mapGrid");
  grid.innerHTML = "";
  parks.forEach((p)=>{
    const card = document.createElement("div");
    card.className = "card";
    card.onclick = ()=>{ travelTo(p); mapOverlay.classList.remove("show"); };

    const thumb = document.createElement("div");
    thumb.className = "thumb";
    thumb.textContent = p.emoji;

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.innerHTML = `<b>${p.name}</b><span>${p.subtitle}</span>`;

    const badge = document.createElement("div");
    badge.className = "badge";
    badge.innerHTML = `
      <span class="pill">${discovered.has(p.id) ? "‚úÖ Visited" : "‚¨ú Not yet"}</span>
      <span class="pill">${p.animal.emoji} Meet: ${p.animal.name}</span>
    `;
    meta.appendChild(badge);

    card.appendChild(thumb);
    card.appendChild(meta);
    grid.appendChild(card);
  });
}

// ---------- Passport builder ----------
function buildPassport(){
  const grid = document.getElementById("passportGrid");
  grid.innerHTML = "";
  parks.forEach((p)=>{
    const ok = discovered.has(p.id);
    const el = document.createElement("div");
    el.className = "stamp";
    el.innerHTML = `
      <div class="row">
        <b>${p.name}</b>
        <span class="pill">${ok ? "STAMPED" : "EMPTY"}</span>
      </div>
      <small>${p.subtitle}</small>
      <div class="big">${ok ? "‚úÖ " + p.emoji : "‚¨ú " + p.emoji}</div>
      <small>${p.animal.emoji} Animal friend: ${p.animal.name}</small>
    `;
    grid.appendChild(el);
  });
}

// ---------- Travel ----------
let travelFlash = 0;
function travelTo(park){
  dog.state = "travel";
  moveLeft = moveRight = false;
  dog.vx = 0;
  dog.x = clamp(park.x - 120, 0, WORLD_W - dog.w);
  dog.y = park.y + 78;
  dog.dir = 1;
  centerCameraOn(dog.x, dog.y);
  travelFlash = 18;
  setDogMood("happy", 100, `üß≥ Traveled to ${park.name}!`);
}

// ---------- Mood helper ----------
function setDogMood(state, frames, message){
  dog.state = state;
  dog.timer = frames;
  if(message) toast(message);
}

// ---------- Animals (interactive NPCs) ----------
function getParkAnimal(park){
  return {
    id: "animal_"+park.id,
    x: park.x + 120,
    y: park.y + 60,
    r: 34,
    emoji: park.animal.emoji,
    message: park.animal.message,
    parkId: park.id
  };
}
const animals = parks.map(getParkAnimal);

canvas.addEventListener("pointerdown",(e)=>{
  const rect = canvas.getBoundingClientRect();
  const sx = e.clientX - rect.left;
  const sy = e.clientY - rect.top;
  const wx = sx + camera.x;
  const wy = sy + camera.y;

  for(const a of animals){
    if(dist(wx, wy, a.x, a.y) < a.r + 22){
      setDogMood("happy", 140, `${a.emoji} ${a.message}`);
      return;
    }
  }
});

// ---------- Discovery ----------
function checkDiscovery(){
  for(const p of parks){
    if(discovered.has(p.id)) continue;
    const d = dist(dog.x + dog.w/2, dog.y - 20, p.x, p.y + 40);
    if(d < 95){
      discovered.add(p.id);
      renderHUD();
      setDogMood("happy", 160, `‚ú® Discovered ${p.name} ‚Äî ${p.subtitle}!`);
      if(discovered.size === 10) toast("üèÅ You did it! All 10 landmarks collected!");
      return;
    }
  }
}

// ---------- Sound (footsteps) ----------
let soundOn = false;
let audioCtx = null;
let stepCooldown = 0;

function toggleSound(){
  soundOn = !soundOn;
  soundBtn.textContent = soundOn ? "üîä Sound: On" : "üîä Sound: Off";
  if(soundOn && !audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if(soundOn) toast("üîä Sound on!");
  else toast("üîá Sound off!");
}
soundBtn.onclick = toggleSound;

function playStep(){
  if(!soundOn || !audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = "triangle";
  o.frequency.value = 160 + Math.random()*30;
  g.gain.value = 0.00001;
  o.connect(g);
  g.connect(audioCtx.destination);
  const t = audioCtx.currentTime;
  g.gain.setValueAtTime(0.00001, t);
  g.gain.exponentialRampToValueAtTime(0.05, t + 0.01);
  g.gain.exponentialRampToValueAtTime(0.00001, t + 0.08);
  o.start(t);
  o.stop(t + 0.09);
}

// ---------- Sprite settings ----------
const SPR = {
  keys: {
    idle:  "dog_idle",
    walk:  "dog_walk",
    happy: "dog_idle",
    eat:   "dog_eat",
    paw:   "dog_paw",
    sleep: "dog_sleep"
  },
  scale: 0.55,     // overall size of sprite on canvas
  fps:   10,       // walk animation speed
};

// Walk strip: auto-detect frames (assumes square frames)
function getStripInfo(img){
  if(!img) return { fw: 128, fh: 128, frames: 1 };
  const fh = img.height;
  const frames = Math.max(1, Math.round(img.width / fh)); // e.g. 1536/256 = 6
  const fw = Math.floor(img.width / frames);
  return { fw, fh, frames };
}

// ---------- Update loop ----------
function update(){
  // Smooth acceleration
  if(moveLeft){
    dog.vx -= MOVE.accel;
    dog.dir = -1;
  }
  if(moveRight){
    dog.vx += MOVE.accel;
    dog.dir = 1;
  }

  // Clamp speed
  dog.vx = clamp(dog.vx, -MOVE.maxV, MOVE.maxV);

  // Friction when no input
  if(!moveLeft && !moveRight){
    dog.vx *= MOVE.friction;
    if(Math.abs(dog.vx) < 0.08) dog.vx = 0;
  }

  // Position
  dog.x += dog.vx;
  dog.x = clamp(dog.x, 0, WORLD_W - dog.w);

  // State logic
  const moving = Math.abs(dog.vx) > 0.12;

  if(dog.timer > 0) dog.timer--;
  if(dog.timer === 0){
    // only auto-idle if not moving
    if(moving) dog.state = "walk";
    else dog.state = "idle";
  }

  // If player is actively walking, force walk state
  if((moveLeft || moveRight) && dog.timer === 0){
    dog.state = "walk";
  }

  // Animate
  dog.animTime++;

  // Camera follow
  centerCameraOn(dog.x + dog.w/2, dog.y - 40);

  // Discovery checks
  checkDiscovery();

  // Toast time
  if(toastT > 0){
    toastT--;
    if(toastT === 0) toastEl.classList.remove("show");
  }

  // Travel flash
  if(travelFlash > 0) travelFlash--;

  // Footstep sync
  if(stepCooldown > 0) stepCooldown--;
  if(dog.state === "walk" && moving && stepCooldown === 0){
    playStep();
    stepCooldown = 18; // spacing between steps
  }
}

// ---------- Drawing ----------
function drawBackground(){
  ctx.fillStyle = "#bde0fe";
  ctx.fillRect(0,0,window.innerWidth, window.innerHeight);

  // distant hills
  ctx.fillStyle = "rgba(0,0,0,0.06)";
  for(let i=0;i<14;i++){
    const x = (i*420 - (camera.x*0.35)%420);
    ctx.beginPath();
    ctx.ellipse(x, 240, 260, 120, 0, 0, Math.PI*2);
    ctx.fill();
  }

  // ground
  const groundY = 920 - camera.y;
  ctx.fillStyle = "#8ecae6";
  ctx.fillRect(-camera.x, groundY, WORLD_W, 500);

  // path
  ctx.fillStyle = "rgba(0,0,0,0.10)";
  ctx.fillRect(-camera.x, groundY + 55, WORLD_W, 30);
}

function drawLandmarks(){
  for(const p of parks){
    const sx = p.x - camera.x;
    const sy = p.y - camera.y;

    // post
    ctx.fillStyle = discovered.has(p.id) ? "rgba(0,0,0,0.75)" : "rgba(0,0,0,0.35)";
    ctx.fillRect(sx - 10, sy + 25, 20, 90);

    // sign
    ctx.fillStyle = "rgba(255,255,255,0.92)";
    ctx.fillRect(sx - 110, sy - 20, 220, 48);

    ctx.fillStyle = "#000";
    ctx.font = "14px system-ui";
    ctx.fillText(p.name, sx - 100, sy + 0);
    ctx.font = "12px system-ui";
    ctx.fillText(p.subtitle, sx - 100, sy + 18);

    ctx.font = "18px system-ui";
    ctx.fillText(discovered.has(p.id) ? "‚úÖ" : "‚ú®", sx + 86, sy + 16);
  }
}

function drawAnimals(){
  for(const a of animals){
    const sx = a.x - camera.x;
    const sy = a.y - camera.y;

    ctx.fillStyle = "rgba(255,255,255,0.85)";
    ctx.beginPath();
    ctx.arc(sx, sy, a.r, 0, Math.PI*2);
    ctx.fill();

    ctx.font = "26px system-ui";
    ctx.fillStyle = "#000";
    ctx.fillText(a.emoji, sx - 12, sy + 10);

    ctx.font = "12px system-ui";
    ctx.fillText("tap me", sx - 18, sy + 36);
  }
}

function drawDog(){
  // pick sprite by state
  const key = SPR.keys[dog.state] || "dog_idle";
  const img = images[key];

  const sx = dog.x - camera.x;
  const feetY = dog.y - camera.y; // this is the ground contact line for the sprite

  if(img){
    const { fw, fh, frames } = (key === "dog_walk") ? getStripInfo(img) : { fw: img.width, fh: img.height, frames: 1 };
    const scale = SPR.scale;

    // frame index (only animate walking strip)
    let frame = 0;
    if(key === "dog_walk"){
      const ticksPerFrame = Math.max(1, Math.floor(60 / SPR.fps));
      frame = Math.floor(dog.animTime / ticksPerFrame) % frames;
    }

    const dw = fw * scale;
    const dh = fh * scale;

    // IMPORTANT: anchor sprite so the FEET touch the path, not the head
    const drawX = sx;
    const drawY = feetY - dh + 8; // small tweak so paws sit on the path

    ctx.save();

    // Your walk strip faces RIGHT.
    // Flip ONLY when moving LEFT.
    if(dog.dir === -1){
      ctx.translate(drawX + dw, drawY);
      ctx.scale(-1, 1);
      if(key === "dog_walk"){
        ctx.drawImage(img, frame*fw, 0, fw, fh, 0, 0, dw, dh);
      } else {
        ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, dw, dh);
      }
    } else {
      if(key === "dog_walk"){
        ctx.drawImage(img, frame*fw, 0, fw, fh, drawX, drawY, dw, dh);
      } else {
        ctx.drawImage(img, 0, 0, img.width, img.height, drawX, drawY, dw, dh);
      }
    }

    ctx.restore();
    return;
  }

  // Fallback (should be rare now)
  ctx.fillStyle = "#a97142";
  ctx.fillRect(sx, feetY-60, 80, 60);
}

function drawMinimap(){
  const w = 220, h = 70;
  const x = window.innerWidth - w - 14;
  const y = window.innerHeight - h - 14;

  ctx.fillStyle = "rgba(255,255,255,0.85)";
  ctx.fillRect(x, y, w, h);
  ctx.strokeStyle = "rgba(0,0,0,0.2)";
  ctx.strokeRect(x, y, w, h);

  ctx.fillStyle = "rgba(0,0,0,0.12)";
  ctx.fillRect(x+10, y+34, w-20, 6);

  for(const p of parks){
    const px = x + 10 + (p.x / WORLD_W) * (w-20);
    ctx.fillStyle = discovered.has(p.id) ? "rgba(0,0,0,0.7)" : "rgba(0,0,0,0.25)";
    ctx.beginPath();
    ctx.arc(px, y+37, 4, 0, Math.PI*2);
    ctx.fill();
  }

  const dx = x + 10 + (dog.x / WORLD_W) * (w-20);
  ctx.fillStyle = "rgba(255,183,3,1)";
  ctx.beginPath();
  ctx.arc(dx, y+37, 5, 0, Math.PI*2);
  ctx.fill();

  ctx.font = "12px system-ui";
  ctx.fillStyle = "#000";
  ctx.fillText("Mini-map", x+10, y+16);
}

function drawFlash(){
  if(travelFlash<=0) return;
  ctx.fillStyle = `rgba(255,255,255,${travelFlash/18})`;
  ctx.fillRect(0,0,window.innerWidth,window.innerHeight);
}

function draw(){
  drawBackground();
  drawLandmarks();
  drawAnimals();
  drawDog();
  drawMinimap();
  drawFlash();
}

// ---------- Main loop ----------
function tick(){
  update();
  draw();
  requestAnimationFrame(tick);
}
tick();

// Intro
travelTo(parks[0]);
toast("üê∂ Welcome! Let‚Äôs explore America‚Äôs National Parks together!");
</script>
</body>
</html>
