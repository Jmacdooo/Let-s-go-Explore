<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>My Forever Dog ‚Äî Walk + States + Parks</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif;background:#cfe9ff;}
  canvas{display:block;width:100vw;height:100vh;}
  #ui{
    position:fixed; left:12px; top:12px; z-index:10;
    background:rgba(255,255,255,.92); box-shadow:0 10px 30px rgba(0,0,0,.15);
    border-radius:14px; padding:10px 12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    font-size:12px;
  }
  #ui b{font-size:13px}
  #ui .pill{background:#fff;border:1px solid rgba(0,0,0,.12);border-radius:999px;padding:6px 10px}
  button{border:none;border-radius:10px;padding:8px 10px;background:#111;color:#fff;font-weight:700;cursor:pointer}
  button.secondary{background:#fff;color:#111;border:1px solid rgba(0,0,0,.15)}
  #hint{
    position:fixed; left:12px; bottom:12px; z-index:10;
    background:rgba(255,255,255,.92); box-shadow:0 10px 30px rgba(0,0,0,.15);
    border-radius:14px; padding:10px 12px; font-size:12px;
    max-width:520px;
  }
</style>
</head>
<body>

<div id="ui">
  <b>üêæ My Forever Dog</b>
  <span class="pill">Move: Arrows / WASD</span>
  <span class="pill">Shift = run</span>
  <span class="pill">Pet: click/tap dog</span>
  <span class="pill">Interact: E / tap sign</span>
  <span class="pill">State: <b id="stateLabel">‚Ä¶</b></span>
  <span class="pill">Loaded: <b id="loadedLabel">‚Ä¶</b></span>
  <button id="reset" class="secondary">Reset</button>
</div>

<div id="hint">Loading‚Ä¶</div>

<canvas id="game"></canvas>

<script>
/* =========================
   CANVAS
========================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d", { alpha:true });

function resize(){
  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  canvas.width  = Math.floor(innerWidth  * dpr);
  canvas.height = Math.floor(innerHeight * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
addEventListener("resize", resize);
resize();

/* =========================
   WORLD / GROUND
========================= */
const WORLD_W = 2600;
const WORLD_H = 1400;

const GROUND_Y = 980;
const DOG_FOOT_OFFSET = 8;

const camera = { x:0, y:0 };
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));

/* =========================
   INPUT
========================= */
const keys = new Set();
addEventListener("keydown",(e)=>{
  const k = e.key.toLowerCase();
  keys.add(k);
  if(["arrowup","arrowdown","arrowleft","arrowright"," "].includes(k)) e.preventDefault();
},{passive:false});
addEventListener("keyup",(e)=>keys.delete(e.key.toLowerCase()));

let tap = { x:0, y:0, fired:false };
canvas.addEventListener("pointerdown",(e)=>{
  const r = canvas.getBoundingClientRect();
  tap.x = e.clientX - r.left;
  tap.y = e.clientY - r.top;
  tap.fired = true;
});

/* =========================
   HELPERS (screen/world)
========================= */
function screenToWorld(sx, sy){ return { x: sx + camera.x, y: sy + camera.y }; }
function roundRect(ctx,x,y,w,h,r,fill,stroke){
  const rr = Math.min(r,w/2,h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr,y);
  ctx.arcTo(x+w,y,x+w,y+h,rr);
  ctx.arcTo(x+w,y+h,x,y+h,rr);
  ctx.arcTo(x,y+h,x,y,rr);
  ctx.arcTo(x,y,x+w,y,rr);
  ctx.closePath();
  if(fill) ctx.fill();
  if(stroke) ctx.stroke();
}
function inRect(px,py,r){ return px>=r.x && px<=r.x+r.w && py>=r.y && py<=r.y+r.h; }

/* =========================
   IMAGE LOADING + CROPPING
========================= */
function loadImage(src){
  return new Promise((resolve,reject)=>{
    const im = new Image();
    im.onload = ()=>resolve(im);
    im.onerror = ()=>reject(new Error("Failed to load "+src));
    im.src = src + "?v=" + Date.now();
  });
}

function cropTransparentMargins(img){
  const w = img.naturalWidth || img.width;
  const h = img.naturalHeight || img.height;

  const off = document.createElement("canvas");
  off.width = w; off.height = h;
  const octx = off.getContext("2d", { willReadFrequently:true });
  octx.clearRect(0,0,w,h);
  octx.drawImage(img,0,0);

  const data = octx.getImageData(0,0,w,h).data;
  let minX=w, minY=h, maxX=0, maxY=0, found=false;

  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const a = data[(y*w + x)*4 + 3];
      if(a > 5){
        found=true;
        if(x<minX)minX=x;
        if(y<minY)minY=y;
        if(x>maxX)maxX=x;
        if(y>maxY)maxY=y;
      }
    }
  }
  if(!found) return off;

  const pad = 6;
  minX = Math.max(0, minX - pad);
  minY = Math.max(0, minY - pad);
  maxX = Math.min(w-1, maxX + pad);
  maxY = Math.min(h-1, maxY + pad);

  const cw = maxX - minX + 1;
  const ch = maxY - minY + 1;

  const cropped = document.createElement("canvas");
  cropped.width = cw; cropped.height = ch;
  cropped.getContext("2d").drawImage(off, minX, minY, cw, ch, 0, 0, cw, ch);
  return cropped;
}

function makeSprite(img, frames=1){
  const sheet = cropTransparentMargins(img);
  const frameW = Math.floor(sheet.width / frames);
  const frameH = sheet.height;
  return { sheet, frames, frameW, frameH };
}

/* =========================
   ASSETS (YOUR REAL PATHS)
========================= */
const ASSETS = {
  walk:  { src:"assets/dog_walk.png",  frames:6 },
  idle:  { src:"assets/dog_idle.png",  frames:1 },
  sleep: { src:"assets/dog_sleep.png", frames:1 },
  paw:   { src:"assets/dog_paw.png",   frames:1 },
};

const SPR = { walk:null, idle:null, sleep:null, paw:null };

const stateLabel = document.getElementById("stateLabel");
const loadedLabel = document.getElementById("loadedLabel");
const hint = document.getElementById("hint");

/* =========================
   DOG STATE MACHINE
========================= */
const DOG = {
  x: WORLD_W/2, y: GROUND_Y,
  vx:0, vy:0,
  facing: 1,
  state: "idle",   // idle | walk | sleep | paw
  stateT: 0,
  frame: 0,
  animT: 0,
  idleStillT: 0,
  speed: 320,
  runMult: 1.75,
  targetH: 170
};

function setState(s, duration=0){
  DOG.state = s;
  DOG.stateT = duration;
  DOG.frame = 0;
  DOG.animT = 0;
  stateLabel.textContent = s;
}

function currentSprite(){
  if(DOG.state === "walk") return SPR.walk || SPR.idle;
  if(DOG.state === "sleep") return SPR.sleep || SPR.idle;
  if(DOG.state === "paw") return SPR.paw || SPR.idle;
  return SPR.idle || SPR.walk;
}

/* =========================
   PARKS (SIGNS)
========================= */
const parks = [
  { id:"yose", name:"Yosemite", subtitle:"Half Dome", x:520,  y:GROUND_Y-30, w:220, h:90, visited:false },
  { id:"gc",   name:"Grand Canyon", subtitle:"South Rim View", x:1400, y:GROUND_Y-30, w:260, h:90, visited:false },
  { id:"zion", name:"Zion", subtitle:"Angels Landing", x:2050, y:GROUND_Y-30, w:220, h:90, visited:false },
];

function nearestPark(){
  let best=null, bestD=1e9;
  for(const p of parks){
    const cx = p.x + p.w/2, cy = p.y;
    const d = Math.hypot(DOG.x - cx, DOG.y - cy);
    if(d < bestD){ bestD=d; best=p; }
  }
  return (bestD < 160) ? best : null;
}

function visitPark(p){
  p.visited = true;
  hint.innerHTML = `üìç Visited <b>${p.name}</b> ‚Äî ${p.subtitle}!`;
  // cute behavior: paw for a moment
  setState("paw", 1.0);
}

/* =========================
   HITBOX for dog (tap-to-pet)
========================= */
function dogBounds(){
  const spr = currentSprite();
  if(!spr) return {x:DOG.x,y:DOG.y,w:1,h:1};
  const scale = DOG.targetH / spr.frameH;
  const w = spr.frameW * scale;
  const h = spr.frameH * scale;
  const x = DOG.x - w/2;
  const y = (DOG.y - h) + DOG_FOOT_OFFSET;
  return {x,y,w,h};
}

/* =========================
   UPDATE
========================= */
let last = performance.now();

function update(dt){
  // Resolve timed states
  if(DOG.stateT > 0){
    DOG.stateT -= dt;
    if(DOG.stateT <= 0) setState("idle");
  }

  // Tap handling
  if(tap.fired){
    tap.fired = false;
    const wpt = screenToWorld(tap.x, tap.y);

    // tap dog => paw
    if(inRect(wpt.x, wpt.y, dogBounds())){
      setState("paw", 1.0);
      hint.innerHTML = "üêæ Aww! He gave you a paw.";
    } else {
      // tap sign => visit
      for(const p of parks){
        const r = { x:p.x, y:p.y-100, w:p.w, h:p.h+140 };
        if(inRect(wpt.x, wpt.y, r)){ visitPark(p); break; }
      }
    }
  }

  // E interaction
  if(keys.has("e")){
    keys.delete("e");
    const p = nearestPark();
    if(p) visitPark(p);
    else hint.innerHTML = "Walk closer to a sign, then press <b>E</b>.";
  }

  const locked = (DOG.state === "paw" || DOG.state === "sleep");

  const left  = keys.has("arrowleft")  || keys.has("a");
  const right = keys.has("arrowright") || keys.has("d");
  const up    = keys.has("arrowup")    || keys.has("w");
  const down  = keys.has("arrowdown")  || keys.has("s");
  const run   = keys.has("shift");

  let ax=0, ay=0;
  if(!locked){
    if(left) ax -= 1;
    if(right) ax += 1;
    if(up) ay -= 1;
    if(down) ay += 1;
  }

  const mag = Math.hypot(ax,ay) || 1;
  ax/=mag; ay/=mag;

  const spd = DOG.speed * (run ? DOG.runMult : 1);
  DOG.vx = ax * spd;
  DOG.vy = ay * spd;

  DOG.x += DOG.vx * dt;
  DOG.y += DOG.vy * dt;

  DOG.x = clamp(DOG.x, 60, WORLD_W-60);
  DOG.y = clamp(DOG.y, GROUND_Y-120, GROUND_Y+120);

  if(DOG.vx > 6) DOG.facing = 1;
  if(DOG.vx < -6) DOG.facing = -1;

  const moving = (Math.abs(DOG.vx) + Math.abs(DOG.vy)) > 2;

  // Sleep if idle too long
  if(!locked && !moving && DOG.state === "idle"){
    DOG.idleStillT += dt;
    if(DOG.idleStillT > 6){
      setState("sleep");
      hint.innerHTML = "üò¥ He got sleepy and took a nap. Move to wake him.";
    }
  } else {
    DOG.idleStillT = 0;
  }

  // Wake on movement keys
  if(DOG.state === "sleep" && (left||right||up||down)){
    setState("idle");
    hint.innerHTML = "üê∂ He woke up!";
  }

  // State transitions
  if(!locked){
    if(moving){
      if(DOG.state !== "walk") setState("walk");
    } else {
      if(DOG.state === "walk") setState("idle");
    }
  }

  // Animate walk sheet
  const spr = currentSprite();
  if(spr && spr.frames > 1 && DOG.state === "walk" && moving){
    DOG.animT += dt;
    const fps = run ? 16 : 12;
    if(DOG.animT >= 1/fps){
      DOG.animT = 0;
      DOG.frame = (DOG.frame + 1) % spr.frames;
    }
  } else {
    DOG.frame = 0;
  }

  // camera follows
  camera.x = clamp(DOG.x - innerWidth/2, 0, WORLD_W - innerWidth);
  camera.y = clamp(DOG.y - innerHeight/2, 0, WORLD_H - innerHeight);

  const near = nearestPark();
  if(near && !near.visited){
    hint.innerHTML = `Press <b>E</b> to visit <b>${near.name}</b> ‚Äî or tap the sign.`;
  }
}

/* =========================
   DRAW
========================= */
function draw(){
  ctx.clearRect(0,0,innerWidth,innerHeight);

  ctx.fillStyle = "#bfe3ff";
  ctx.fillRect(0,0,innerWidth,innerHeight);

  ctx.save();
  ctx.translate(-camera.x, -camera.y);

  // soft hills
  ctx.fillStyle = "rgba(0,0,0,.06)";
  for(let i=0;i<6;i++){
    ctx.beginPath();
    ctx.ellipse(250 + i*520, 260, 520, 160, 0, 0, Math.PI*2);
    ctx.fill();
  }

  // ground
  ctx.fillStyle = "rgba(0,0,0,.10)";
  ctx.fillRect(0, GROUND_Y+40, WORLD_W, WORLD_H-(GROUND_Y+40));
  ctx.fillStyle = "rgba(255,255,255,.22)";
  ctx.fillRect(0, GROUND_Y+10, WORLD_W, 24);

  drawParks(false);
  drawDog();
  drawParks(true);

  ctx.restore();

  // debug
  ctx.fillStyle = "rgba(0,0,0,.55)";
  ctx.font = "12px system-ui";
  ctx.fillText(`frame ${DOG.frame+1}`, 14, innerHeight-14);
}

function drawParks(foreground){
  for(const p of parks){
    const sx = p.x, sy = p.y-95, w=p.w, h=p.h;

    if(!foreground){
      ctx.fillStyle = "rgba(0,0,0,.20)";
      ctx.fillRect(sx + w/2 - 8, sy + h, 16, 70);
      ctx.fillStyle = "rgba(0,0,0,.08)";
      ctx.fillRect(sx + w/2 - 28, sy + h + 62, 56, 10);
    }

    ctx.fillStyle = "rgba(255,255,255,.92)";
    roundRect(ctx, sx, sy, w, h, 14, true, false);

    ctx.strokeStyle = p.visited ? "rgba(0,160,80,.55)" : "rgba(0,0,0,.16)";
    ctx.lineWidth = 2;
    roundRect(ctx, sx, sy, w, h, 14, false, true);

    ctx.fillStyle = "rgba(0,0,0,.78)";
    ctx.font = "700 16px system-ui";
    ctx.fillText(p.name, sx+12, sy+28);
    ctx.font = "12px system-ui";
    ctx.fillText(p.subtitle, sx+12, sy+50);

    ctx.fillStyle = p.visited ? "rgba(0,180,80,.95)" : "rgba(0,0,0,.18)";
    ctx.fillRect(sx + w - 28, sy + 14, 14, 14);
  }
}

function drawDog(){
  const px = DOG.x, py = DOG.y;
  const spr = currentSprite();

  if(!spr || !spr.sheet){
    ctx.fillStyle = "rgba(0,0,0,.35)";
    ctx.beginPath(); ctx.arc(px, py, 26, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "#fff";
    ctx.fillText("loading dog assets‚Ä¶", px-70, py-40);
    return;
  }

  const scale = DOG.targetH / spr.frameH;
  const drawW = spr.frameW * scale;
  const drawH = spr.frameH * scale;

  const dx = px - drawW/2;
  const dy = (py - drawH) + DOG_FOOT_OFFSET;

  const sx = (spr.frames > 1 ? DOG.frame * spr.frameW : 0);

  ctx.save();
  if(DOG.facing === -1){
    ctx.translate(px, 0);
    ctx.scale(-1, 1);
    ctx.translate(-px, 0);
  }
  ctx.drawImage(spr.sheet, sx, 0, spr.frameW, spr.frameH, dx, dy, drawW, drawH);
  ctx.restore();
}

/* =========================
   LOOP
========================= */
function loop(now){
  const dt = Math.min(0.033, (now - last)/1000);
  last = now;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}

/* =========================
   RESET
========================= */
document.getElementById("reset").addEventListener("click", ()=>{
  DOG.x = WORLD_W/2;
  DOG.y = GROUND_Y;
  DOG.vx = DOG.vy = 0;
  DOG.facing = 1;
  for(const p of parks) p.visited = false;
  setState("idle");
  hint.innerHTML = "Reset! Walk to a sign and press <b>E</b> (or tap it).";
});

/* =========================
   LOAD EVERYTHING THEN START
========================= */
(async function start(){
  try{
    loadedLabel.textContent = "loading‚Ä¶";

    // IMPORTANT: real paths for your repo
    SPR.walk  = makeSprite(await loadImage(ASSETS.walk.src),  ASSETS.walk.frames);
    SPR.idle  = makeSprite(await loadImage(ASSETS.idle.src),  ASSETS.idle.frames);
    SPR.sleep = makeSprite(await loadImage(ASSETS.sleep.src), ASSETS.sleep.frames);
    SPR.paw   = makeSprite(await loadImage(ASSETS.paw.src),   ASSETS.paw.frames);

    loadedLabel.textContent = "assets/‚Ä¶ ‚úÖ";
    setState("idle");
    hint.innerHTML = "‚úÖ Loaded! Click/tap the dog to pet him. Walk to a sign and press <b>E</b>.";
    requestAnimationFrame(loop);
  }catch(e){
    console.error(e);
    loadedLabel.textContent = "FAILED";
    hint.textContent = "‚ùå Images failed to load. Make sure these exist: assets/dog_walk.png, assets/dog_idle.png, assets/dog_sleep.png, assets/dog_paw.png";
  }
})();
</script>
</body>
</html>
