<script>
/* =========================================================
   MY FOREVER DOG â€” CLEAN + WORKING SPRITES
   Expects files in: assets/dog/
     - dog_idle.png
     - dog_walk.png   (strip with 6 frames)
     - dog_eat.png
     - dog_happy.png
   ========================================================= */

// ---------- Canvas sizing ----------
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = Math.floor(window.innerWidth * devicePixelRatio);
  canvas.height = Math.floor(window.innerHeight * devicePixelRatio);
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
window.addEventListener("resize", resize);
resize();

// ---------- Helpers ----------
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const dist = (x1,y1,x2,y2)=>Math.hypot(x1-x2,y1-y2);

// ---------- World ----------
const WORLD_W = 5200;
const WORLD_H = 1400;
const PATH_Y = 860;

// Camera follows dog
const camera = { x: 0, y: 0 };
function centerCameraOn(wx, wy){
  camera.x = clamp(wx - window.innerWidth/2, 0, WORLD_W - window.innerWidth);
  camera.y = clamp(wy - window.innerHeight/2, 0, WORLD_H - window.innerHeight);
}

// ---------- Assets ----------
const ASSET_BASE = "assets/dog/";
window.images = window.images || {};
const images = window.images;

function loadImage(key, src){
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = ()=>{ images[key] = img; resolve(true); };
    img.onerror = ()=>{ images[key] = null; resolve(false); };
    img.src = src;
  });
}

(async function loadAssets(){
  await loadImage("dog_idle",  ASSET_BASE + "dog_idle.png");
  await loadImage("dog_walk",  ASSET_BASE + "dog_walk.png");
  await loadImage("dog_eat",   ASSET_BASE + "dog_eat.png");
  await loadImage("dog_happy", ASSET_BASE + "dog_happy.png");

  // If happy missing, reuse idle
  if(!images["dog_happy"]) images["dog_happy"] = images["dog_idle"];
  console.log("ASSETS:", Object.keys(images).filter(k=>images[k]));
})();

// ---------- Parks / Landmarks (10) ----------
const parks = [
  { id:"yosemite", name:"Yosemite", subtitle:"Half Dome", emoji:"â›°ï¸", x: 320,  y: PATH_Y,  animal:{ name:"Black Bear", emoji:"ðŸ»", message:"A bear sniffs the airâ€¦ your dog stays calm. Good pup!" } },
  { id:"grandcanyon", name:"Grand Canyon", subtitle:"South Rim View", emoji:"ðŸ§¡", x: 820,  y: PATH_Y,  animal:{ name:"Condor", emoji:"ðŸ¦…", message:"A condor glides overhead. Your dog looks up like: wow!" } },
  { id:"zion", name:"Zion", subtitle:"Angels Landing", emoji:"ðŸª¨", x: 1320, y: PATH_Y,  animal:{ name:"Bighorn Sheep", emoji:"ðŸ", message:"A bighorn sheep poses for a photo. Your dog wags politely." } },
  { id:"arches", name:"Arches", subtitle:"Delicate Arch", emoji:"ðŸŒ…", x: 1820, y: PATH_Y,  animal:{ name:"Desert Fox", emoji:"ðŸ¦Š", message:"A fox darts by! Your dog freezesâ€¦ then smiles." } },
  { id:"yellowstone", name:"Yellowstone", subtitle:"Old Faithful", emoji:"ðŸ’¦", x: 2320, y: PATH_Y, animal:{ name:"Bison", emoji:"ðŸ¦¬", message:"A bison is nearby. Your dog keeps a respectful distance. Smart!" } },
  { id:"tetons", name:"Grand Teton", subtitle:"Teton Range", emoji:"ðŸ”ï¸", x: 2820, y: PATH_Y,  animal:{ name:"Moose", emoji:"ðŸ«Ž", message:"A moose munches leaves. Your dog is amazed (and quiet)." } },
  { id:"glacier", name:"Glacier", subtitle:"Going-to-the-Sun Road", emoji:"â„ï¸", x: 3320, y: PATH_Y, animal:{ name:"Mountain Goat", emoji:"ðŸ", message:"A mountain goat climbs like a superhero." } },
  { id:"rockymtn", name:"Rocky Mountain", subtitle:"Trail Ridge Road", emoji:"ðŸŒ²", x: 3820, y: PATH_Y, animal:{ name:"Elk", emoji:"ðŸ¦Œ", message:"An elk bugles! Your dog tilts head: â€˜What was THAT?â€™" } },
  { id:"acadia", name:"Acadia", subtitle:"Cadillac Mountain", emoji:"ðŸŒŠ", x: 4320, y: PATH_Y, animal:{ name:"Harbor Seal", emoji:"ðŸ¦­", message:"A seal pops up and splashes. Your dog is delighted." } },
  { id:"everglades", name:"Everglades", subtitle:"Alligator Alley", emoji:"ðŸŠ", x: 4820, y: PATH_Y, animal:{ name:"Alligator", emoji:"ðŸŠ", message:"You spot an alligator (from far away!). Your dog stays safe." } },
];

const discovered = new Set();

// ---------- Dog ----------
const dog = {
  x: 240,
  y: PATH_Y + 60,
  speed: 3.4,
  dir: 1,
  state: "idle", // idle | walk | happy | eat | travel
  timer: 0,
  animTime: 0
};

// ---------- Controls ----------
let moveLeft=false, moveRight=false;
const leftBtn = document.getElementById("leftBtn");
const rightBtn = document.getElementById("rightBtn");
const stopBtn = document.getElementById("stopBtn");
const petBtn = document.getElementById("petBtn");
const feedBtn = document.getElementById("feedBtn");
const mapBtn = document.getElementById("mapBtn");
const passportBtn = document.getElementById("passportBtn");

leftBtn.onclick = ()=>{ moveLeft=true; moveRight=false; dog.dir=-1; dog.state="walk"; };
rightBtn.onclick= ()=>{ moveRight=true; moveLeft=false; dog.dir= 1; dog.state="walk"; };
stopBtn.onclick = ()=>{ moveLeft=false; moveRight=false; dog.state="idle"; };
petBtn.onclick  = ()=>setDogMood("happy", 140, "â¤ï¸ Your dog feels loved!");
feedBtn.onclick = ()=>setDogMood("eat", 160, "ðŸ– Yum! Happy dog energy!");

window.addEventListener("keydown",(e)=>{
  if(e.key==="ArrowLeft") leftBtn.onclick();
  if(e.key==="ArrowRight") rightBtn.onclick();
  if(e.key===" ") stopBtn.onclick();
  if(e.key.toLowerCase()==="m") openMap();
  if(e.key.toLowerCase()==="p") openPassport();
  if(e.key.toLowerCase()==="f") feedBtn.onclick();
});

// ---------- Toast ----------
const toastEl = document.getElementById("toast");
let toastT = 0;
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  toastT = 180;
}

// ---------- Panels ----------
const mapOverlay = document.getElementById("mapOverlay");
const passportOverlay = document.getElementById("passportOverlay");
document.getElementById("closeMapBtn").onclick = ()=>mapOverlay.classList.remove("show");
document.getElementById("closePassportBtn").onclick = ()=>passportOverlay.classList.remove("show");
mapOverlay.addEventListener("click",(e)=>{ if(e.target===mapOverlay) mapOverlay.classList.remove("show"); });
passportOverlay.addEventListener("click",(e)=>{ if(e.target===passportOverlay) passportOverlay.classList.remove("show"); });

function openMap(){ buildMap(); mapOverlay.classList.add("show"); }
function openPassport(){ buildPassport(); passportOverlay.classList.add("show"); }
mapBtn.onclick = openMap;
passportBtn.onclick = openPassport;

// ---------- HUD ----------
const countEl = document.getElementById("count");
const progressEl = document.getElementById("progress");
function renderHUD(){
  countEl.textContent = discovered.size;
  progressEl.innerHTML = parks.map(p=>{
    const ok = discovered.has(p.id);
    return `${ok?"âœ…":"â¬œ"} <b>${p.name}</b> â€” ${p.subtitle}`;
  }).join("<br/>");
}
renderHUD();

// ---------- Map builder ----------
function buildMap(){
  const grid = document.getElementById("mapGrid");
  grid.innerHTML = "";
  parks.forEach((p)=>{
    const card = document.createElement("div");
    card.className = "card";
    card.onclick = ()=>{ travelTo(p); mapOverlay.classList.remove("show"); };

    const thumb = document.createElement("div");
    thumb.className = "thumb";
    thumb.textContent = p.emoji;

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.innerHTML = `<b>${p.name}</b><span>${p.subtitle}</span>`;

    const badge = document.createElement("div");
    badge.className = "badge";
    const ok = discovered.has(p.id);
    badge.innerHTML = `
      <span class="pill">${ok ? "âœ… Visited" : "â¬œ Not yet"}</span>
      <span class="pill">${p.animal.emoji} Meet: ${p.animal.name}</span>
    `;
    meta.appendChild(badge);

    card.appendChild(thumb);
    card.appendChild(meta);
    grid.appendChild(card);
  });
}

// ---------- Passport builder ----------
function buildPassport(){
  const grid = document.getElementById("passportGrid");
  grid.innerHTML = "";
  parks.forEach((p)=>{
    const ok = discovered.has(p.id);
    const el = document.createElement("div");
    el.className = "stamp";
    el.innerHTML = `
      <div class="row">
        <b>${p.name}</b>
        <span class="pill">${ok ? "STAMPED" : "EMPTY"}</span>
      </div>
      <small>${p.subtitle}</small>
      <div class="big">${ok ? "âœ… " + p.emoji : "â¬œ " + p.emoji}</div>
      <small>${p.animal.emoji} Animal friend: ${p.animal.name}</small>
    `;
    grid.appendChild(el);
  });
}

// ---------- Travel ----------
let travelFlash = 0;
function travelTo(park){
  dog.state = "travel";
  moveLeft = moveRight = false;

  dog.x = clamp(park.x - 110, 0, WORLD_W - 200);
  dog.y = park.y + 60;
  dog.dir = 1;

  centerCameraOn(dog.x, dog.y);
  travelFlash = 18;
  setDogMood("happy", 90, `ðŸ§³ Traveled to ${park.name}!`);
}

// ---------- Mood helper ----------
function setDogMood(state, frames, message){
  dog.state = state;
  dog.timer = frames;
  if(message) toast(message);
}

// ---------- Animals ----------
function getParkAnimal(park){
  return {
    x: park.x + 120,
    y: park.y + 60,
    r: 34,
    emoji: park.animal.emoji,
    message: park.animal.message
  };
}
const animals = parks.map(getParkAnimal);

canvas.addEventListener("pointerdown",(e)=>{
  const rect = canvas.getBoundingClientRect();
  const sx = e.clientX - rect.left;
  const sy = e.clientY - rect.top;
  const wx = sx + camera.x;
  const wy = sy + camera.y;

  for(const a of animals){
    if(dist(wx, wy, a.x, a.y) < a.r + 22){
      setDogMood("happy", 140, `${a.emoji} ${a.message}`);
      return;
    }
  }
});

// ---------- Discovery ----------
function checkDiscovery(){
  for(const p of parks){
    if(discovered.has(p.id)) continue;
    if(dist(dog.x+80, dog.y+40, p.x, p.y+60) < 95){
      discovered.add(p.id);
      renderHUD();
      setDogMood("happy", 160, `âœ¨ Discovered ${p.name} â€” ${p.subtitle}!`);
      if(discovered.size === 10) toast("ðŸ You did it! All 10 landmarks collected!");
      return;
    }
  }
}

// ---------- Update ----------
function update(){
  if(moveLeft) dog.x -= dog.speed;
  if(moveRight) dog.x += dog.speed;
  dog.x = clamp(dog.x, 0, WORLD_W - 220);

  if(dog.timer > 0) dog.timer--;
  if(dog.timer === 0 && !moveLeft && !moveRight) dog.state = "idle";

  dog.animTime += 1;
  centerCameraOn(dog.x + 80, dog.y + 40);
  checkDiscovery();

  if(toastT > 0){
    toastT--;
    if(toastT === 0) toastEl.classList.remove("show");
  }
  if(travelFlash > 0) travelFlash--;
}

// ---------- Draw helpers ----------
function drawBackground(){
  ctx.fillStyle = "#bde0fe";
  ctx.fillRect(0,0,window.innerWidth, window.innerHeight);

  ctx.fillStyle = "rgba(0,0,0,0.06)";
  for(let i=0;i<14;i++){
    const x = (i*420 - (camera.x*0.35)%420);
    ctx.beginPath();
    ctx.ellipse(x, 240, 260, 120, 0, 0, Math.PI*2);
    ctx.fill();
  }

  const groundY = 920 - camera.y;
  ctx.fillStyle = "#8ecae6";
  ctx.fillRect(-camera.x, groundY, WORLD_W, 500);

  ctx.fillStyle = "rgba(0,0,0,0.10)";
  ctx.fillRect(-camera.x, groundY + 55, WORLD_W, 30);
}

function drawLandmarks(){
  for(const p of parks){
    const sx = p.x - camera.x;
    const sy = p.y - camera.y;

    ctx.fillStyle = discovered.has(p.id) ? "rgba(0,0,0,0.75)" : "rgba(0,0,0,0.35)";
    ctx.fillRect(sx - 10, sy + 25, 20, 90);

    ctx.fillStyle = "rgba(255,255,255,0.92)";
    ctx.fillRect(sx - 110, sy - 20, 220, 48);

    ctx.fillStyle = "#000";
    ctx.font = "14px system-ui";
    ctx.fillText(p.name, sx - 100, sy + 0);
    ctx.font = "12px system-ui";
    ctx.fillText(p.subtitle, sx - 100, sy + 18);

    ctx.font = "18px system-ui";
    ctx.fillText(discovered.has(p.id) ? "âœ…" : "âœ¨", sx + 86, sy + 16);
  }
}

function drawAnimals(){
  for(const a of animals){
    const sx = a.x - camera.x;
    const sy = a.y - camera.y;

    ctx.fillStyle = "rgba(255,255,255,0.85)";
    ctx.beginPath();
    ctx.arc(sx, sy, a.r, 0, Math.PI*2);
    ctx.fill();

    ctx.font = "26px system-ui";
    ctx.fillStyle = "#000";
    ctx.fillText(a.emoji, sx - 12, sy + 10);

    ctx.font = "12px system-ui";
    ctx.fillText("tap me", sx - 18, sy + 36);
  }
}

// Keep aspect ratio (prevents â€œsquishedâ€ dog)
function drawImageAR(img, x, y, maxW, maxH, flip){
  const ar = img.width / img.height;
  let w = maxW, h = maxH;
  if (w / h > ar) w = h * ar; else h = w / ar;

  ctx.save();
  if(flip){
    ctx.translate(x + w, y);
    ctx.scale(-1, 1);
    ctx.drawImage(img, 0, 0, w, h);
  } else {
    ctx.drawImage(img, x, y, w, h);
  }
  ctx.restore();
}

function drawDog(){
  const sx = dog.x - camera.x;
  const sy = dog.y - camera.y;

  // Set how big the dog should appear on screen
  const maxW = 220;
  const maxH = 180;
  const flip = (dog.dir === -1);

  // WALK: sprite strip with 6 frames
  if(dog.state === "walk" && images["dog_walk"]){
    const sheet = images["dog_walk"];
    const frames = 6;
    const fw = Math.floor(sheet.width / frames);
    const fh = sheet.height;

    const speedFps = 10;
    const t = Math.floor(dog.animTime / (60 / speedFps)) % frames;

    // draw one frame, preserving aspect ratio by scaling fw/fh into maxW/maxH
    const ar = fw / fh;
    let w = maxW, h = maxH;
    if (w / h > ar) w = h * ar; else h = w / ar;

    ctx.save();
    if(flip){
      ctx.translate(sx + w, sy);
      ctx.scale(-1, 1);
      ctx.drawImage(sheet, t*fw, 0, fw, fh, 0, 0, w, h);
    } else {
      ctx.drawImage(sheet, t*fw, 0, fw, fh, sx, sy, w, h);
    }
    ctx.restore();
    return;
  }

  // IDLE / HAPPY / EAT: single transparent PNG
  const key =
    dog.state === "eat"   ? "dog_eat" :
    dog.state === "happy" ? "dog_happy" :
                            "dog_idle";

  const img = images[key];
  if(img){
    drawImageAR(img, sx, sy, maxW, maxH, flip);
    return;
  }

  // Fallback (should almost never happen now)
  ctx.fillStyle = "#a97142";
  ctx.fillRect(sx, sy, 84, 64);
}

function drawMinimap(){
  const w = 220, h = 70;
  const x = window.innerWidth - w - 14;
  const y = window.innerHeight - h - 14;

  ctx.fillStyle = "rgba(255,255,255,0.85)";
  ctx.fillRect(x, y, w, h);
  ctx.strokeStyle = "rgba(0,0,0,0.2)";
  ctx.strokeRect(x, y, w, h);

  ctx.fillStyle = "rgba(0,0,0,0.12)";
  ctx.fillRect(x+10, y+34, w-20, 6);

  for(const p of parks){
    const px = x + 10 + (p.x / WORLD_W) * (w-20);
    ctx.fillStyle = discovered.has(p.id) ? "rgba(0,0,0,0.7)" : "rgba(0,0,0,0.25)";
    ctx.beginPath();
    ctx.arc(px, y+37, 4, 0, Math.PI*2);
    ctx.fill();
  }

  const dx = x + 10 + (dog.x / WORLD_W) * (w-20);
  ctx.fillStyle = "rgba(255,183,3,1)";
  ctx.beginPath();
  ctx.arc(dx, y+37, 5, 0, Math.PI*2);
  ctx.fill();

  ctx.font = "12px system-ui";
  ctx.fillStyle = "#000";
  ctx.fillText("Mini-map", x+10, y+16);
}

function drawFlash(){
  if(travelFlash<=0) return;
  ctx.fillStyle = `rgba(255,255,255,${travelFlash/18})`;
  ctx.fillRect(0,0,window.innerWidth,window.innerHeight);
}

function draw(){
  drawBackground();
  drawLandmarks();
  drawAnimals();
  drawDog();
  drawMinimap();
  drawFlash();
}

// ---------- Main loop ----------
function tick(){
  update();
  draw();
  requestAnimationFrame(tick);
}
tick();

// Intro
travelTo(parks[0]);
toast("ðŸ¶ Welcome! Letâ€™s explore Americaâ€™s National Parks together!");
</script>
