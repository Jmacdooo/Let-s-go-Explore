<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>My Forever Dog ‚Äî Yosemite Parks</title>
<style>
  body{
    margin:0;
    background:#000;
    overflow:hidden;
    font-family: system-ui, -apple-system, sans-serif;
  }
  canvas{
    display:block;
    width:100vw;
    height:100vh;
  }
  #controls{
    position:fixed;
    left:10px;
    top:10px;
    z-index:10;
    background:rgba(255,255,255,.9);
    padding:8px 10px;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,.2);
  }
  button{
    padding:8px 10px;
    margin:2px;
    border-radius:10px;
    border:none;
    cursor:pointer;
    font-weight:600;
    background:#ffb703;
  }
  #msg{
    position:fixed;
    left:50%;
    bottom:12px;
    transform:translateX(-50%);
    background:rgba(255,255,255,.95);
    padding:8px 14px;
    border-radius:14px;
    box-shadow:0 4px 12px rgba(0,0,0,.2);
    font-size:14px;
    max-width:90vw;
    text-align:center;
  }
  #progress{
    position:fixed;
    right:10px;
    top:10px;
    z-index:10;
    background:rgba(255,255,255,.9);
    padding:6px 10px;
    border-radius:10px;
    box-shadow:0 4px 12px rgba(0,0,0,.2);
    font-size:13px;
  }
</style>
</head>
<body>

<div id="controls">
  <button id="leftBtn">‚¨Ö Walk</button>
  <button id="stopBtn">‚è∏ Stop</button>
  <button id="rightBtn">Walk ‚û°</button>
  <button id="petBtn">‚ù§Ô∏è Pet</button>
  <button id="feedBtn">üçñ Feed</button>
</div>

<div id="progress">Visited: 0 / 3 landmarks</div>
<div id="msg">Walk to visit the national parks!</div>

<canvas id="game"></canvas>

<script>
// ===================================================
// Setup canvas
// ===================================================
const canvas = document.getElementById("game");
const ctx    = canvas.getContext("2d");
const msgEl  = document.getElementById("msg");
const progressEl = document.getElementById("progress");

function resize(){
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

function dogGroundY(){ return canvas.height - 70; }
function signGroundY(){ return canvas.height - 150; }

// ===================================================
// Image helpers
// ===================================================
function loadImage(path){
  const img = new Image();
  img.src = path;
  return img;
}

// MAIN Yosemite path background
const bgMain      = loadImage("assets/yosemite.png");           // your main Yosemite image
const bgHalfDome  = loadImage("assets/parks/half_dome.png");    // real Half Dome photo
const bgYoseFalls = loadImage("assets/parks/yosemite_falls.png");
const bgTunnel    = loadImage("assets/parks/tunnel_view.png");

let currentBg = "main"; // "main", "half_dome", "yose_falls", "tunnel_view"

// DOG sprites (strip faces LEFT)
const dogWalkImg = loadImage("assets/dog_walk.png");    // 6 frames, 256x256 each
const dogIdleImg = loadImage("assets/dog_idle.png");    // single frame

const DOG_FRAME_W     = 256;
const DOG_FRAME_H     = 256;
const DOG_WALK_FRAMES = 6;
const DOG_SCALE       = 0.8;
const DOG_SPEED       = 260;   // pixels per second
const DOG_ANIM_SPEED  = 8;     // frames per second

// Bark sound
let barkSound = null;
try {
  barkSound = new Audio("assets/bark.mp3");
} catch(e) {
  console.warn("bark.mp3 not found");
}
function playBark(){
  if(!barkSound) return;
  barkSound.currentTime = 0;
  barkSound.play().catch(()=>{});
}

// ===================================================
// Landmarks
// ===================================================
const parks = [
  {
    id:"half_dome",
    name:"Half Dome",
    subtitle:"Yosemite",
    pos:0.30,
    bgKey:"half_dome",
    visited:false,
    guideLine:"This is Half Dome, a huge granite rock shaped by glaciers.",
    dogLine:"Whoa! It‚Äôs gigantic! Can we climb just a tiny part?"
  },
  {
    id:"yose_falls",
    name:"Yosemite Falls",
    subtitle:"Upper & Lower Falls",
    pos:0.60,
    bgKey:"yose_falls",
    visited:false,
    guideLine:"These are Yosemite Falls, some of the tallest waterfalls in North America.",
    dogLine:"I can almost feel the mist on my nose!"
  },
  {
    id:"tunnel_view",
    name:"Tunnel View",
    subtitle:"Famous lookout",
    pos:0.90,
    bgKey:"tunnel_view",
    visited:false,
    guideLine:"Tunnel View shows Half Dome, El Capitan, and Bridalveil Fall together.",
    dogLine:"This is the perfect place for a picture of us!"
  }
];

// ===================================================
// Speech (guide + dog)
// ===================================================
let guideVoice = null;
let dogVoice   = null;

function initVoices(){
  if (!("speechSynthesis" in window)) return;
  const voices = window.speechSynthesis.getVoices();
  if (!voices || !voices.length) return;

  guideVoice =
    voices.find(v => v.name.includes("Google UK English Female")) ||
    voices.find(v => v.name.includes("Google US English")) ||
    voices.find(v => v.lang.startsWith("en")) ||
    voices[0];

  dogVoice =
    voices.find(v =>
      v !== guideVoice &&
      v.lang.startsWith("en") &&
      /child|girl|boy|Google UK English|Google US English/i.test(v.name + v.voiceURI)
    ) ||
    voices.find(v => v !== guideVoice && v.lang.startsWith("en")) ||
    voices.find(v => v !== guideVoice) ||
    guideVoice;
}

if ("speechSynthesis" in window) {
  window.speechSynthesis.onvoiceschanged = initVoices;
  initVoices();
}

function speakForLandmark(p, index, total){
  const guideText = `Landmark ${index} of ${total}: ${p.name}. ${p.guideLine || ""}`;
  const dogText   = p.dogLine || "";

  showMsg(guideText + (dogText ? " " + dogText : ""));

  if (!("speechSynthesis" in window)) return;
  const synth = window.speechSynthesis;
  synth.cancel();

  const g = new SpeechSynthesisUtterance(guideText);
  if (guideVoice) g.voice = guideVoice;
  g.rate  = 0.95;
  g.pitch = 1.0;

  g.onend = () => {
    if (!dogText) return;
    const d = new SpeechSynthesisUtterance(dogText);
    d.voice = dogVoice || guideVoice;
    d.rate  = 1.1;
    d.pitch = 1.2;
    synth.speak(d);
  };

  synth.speak(g);
}

// ===================================================
// Dog + controls
// ===================================================
const dog = {
  x: canvas.width * 0.15,
  dir: -1,          // -1 = left, 1 = right; art faces LEFT
  state: "idle",    // "idle" or "walk"
  frame: 0,
  frameTime: 0
};

const leftBtn  = document.getElementById("leftBtn");
const rightBtn = document.getElementById("rightBtn");
const stopBtn  = document.getElementById("stopBtn");
const petBtn   = document.getElementById("petBtn");
const feedBtn  = document.getElementById("feedBtn");

function stopMoving(){
  dog.state = "idle";
}

leftBtn.onclick = () => {
  dog.dir = -1;
  dog.state = "walk";
  currentBg = "main"; // back to Yosemite path
  if ("speechSynthesis" in window) window.speechSynthesis.cancel();
};

rightBtn.onclick = () => {
  dog.dir = 1;
  dog.state = "walk";
  currentBg = "main"; // back to Yosemite path
  if ("speechSynthesis" in window) window.speechSynthesis.cancel();
};

stopBtn.onclick = () => {
  stopMoving();
  if ("speechSynthesis" in window) window.speechSynthesis.cancel();
};

petBtn.onclick = () => {
  stopMoving();
  playBark();
  showMsg("Your dog loves pets ‚ù§Ô∏è");
};

feedBtn.onclick = () => {
  stopMoving();
  playBark();
  showMsg("Yum! Snack time üçñ");
};

window.addEventListener("keydown", e => {
  if (e.key === "ArrowLeft")  leftBtn.onclick();
  if (e.key === "ArrowRight") rightBtn.onclick();
  if (e.key === " ")          stopBtn.onclick();
});

// ===================================================
// Messages + progress
// ===================================================
let msgTimer = 0;
function showMsg(text){
  msgEl.textContent = text;
  msgTimer = 240; // about 4 seconds
}

// ===================================================
// Update
// ===================================================
function handleLandmark(p, idx){
  stopMoving();
  p.visited = true;

  // change background to real photo for this landmark
  if (p.bgKey === "half_dome")      currentBg = "half_dome";
  else if (p.bgKey === "yose_falls")currentBg = "yose_falls";
  else if (p.bgKey === "tunnel_view") currentBg = "tunnel_view";

  speakForLandmark(p, idx + 1, parks.length);
}

let lastTime = performance.now();

function update(dt){
  // move dog
  if (dog.state === "walk") {
    dog.x += dog.dir * DOG_SPEED * dt;
  }

  // stay on screen
  dog.x = Math.max(60, Math.min(canvas.width - 60, dog.x));

  // check landmarks
  const dogCenter = dog.x;
  parks.forEach((p, i) => {
    const px = p.pos * canvas.width;
    if (!p.visited && Math.abs(dogCenter - px) < 45 && dog.state === "walk") {
      handleLandmark(p, i);
    }
  });

  // progress
  const visitedCount = parks.filter(p => p.visited).length;
  progressEl.textContent = `Visited: ${visitedCount} / ${parks.length} landmarks`;

  if (msgTimer > 0) {
    msgTimer--;
    if (msgTimer === 0) {
      msgEl.textContent = "Walk to visit the national parks!";
    }
  }

  // animation
  dog.frameTime += dt;
  if (dog.state === "walk") {
    const frameDur = 1 / DOG_ANIM_SPEED;
    while (dog.frameTime >= frameDur) {
      dog.frameTime -= frameDur;
      dog.frame = (dog.frame + 1) % DOG_WALK_FRAMES;
    }
  } else {
    dog.frame = 0;
  }
}

// ===================================================
// Drawing
// ===================================================
function drawBackground(){
  let img = null;
  if (currentBg === "half_dome")      img = bgHalfDome;
  else if (currentBg === "yose_falls") img = bgYoseFalls;
  else if (currentBg === "tunnel_view")img = bgTunnel;
  else                                 img = bgMain;

  if (img && img.complete && img.naturalWidth > 0) {
    const imgW = img.width;
    const imgH = img.height;
    const imgAspect = imgW / imgH;
    const canvasAspect = canvas.width / canvas.height;

    let drawW, drawH, drawX, drawY;
    if (canvasAspect > imgAspect) {
      drawW = canvas.width;
      drawH = canvas.width / imgAspect;
      drawX = 0;
      drawY = (canvas.height - drawH) / 2;
    } else {
      drawH = canvas.height;
      drawW = canvas.height * imgAspect;
      drawX = (canvas.width - drawW) / 2;
      drawY = 0;
    }
    ctx.drawImage(img, drawX, drawY, drawW, drawH);
  } else {
    // fallback: blue sky
    ctx.fillStyle = "#bde0fe";
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }

  // light ground strip for clarity
  const gy = dogGroundY();
  ctx.fillStyle = "rgba(255,255,255,0.25)";
  ctx.fillRect(0, gy, canvas.width, canvas.height - gy);
}

function drawParks(){
  const sg = signGroundY();
  ctx.textBaseline = "middle";

  parks.forEach(p => {
    const x = p.pos * canvas.width;
    const signTop = sg - 120;

    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.fillRect(x - 3, signTop + 20, 6, 100);

    ctx.fillStyle = "rgba(255,255,255,0.96)";
    ctx.fillRect(x - 90, signTop, 180, 44);

    ctx.fillStyle = "#000";
    ctx.font = "15px system-ui";
    ctx.fillText(p.name, x - 80, signTop + 14);
    ctx.font = "12px system-ui";
    ctx.fillText(p.subtitle, x - 80, signTop + 30);

    ctx.fillStyle = p.visited ? "#2a9d8f" : "#e76f51";
    ctx.beginPath();
    ctx.arc(x + 70, signTop + 22, 7, 0, Math.PI*2);
    ctx.fill();
  });
}

function drawDog(){
  const gy = dogGroundY();
  const img = (dog.state === "idle" && dogIdleImg.complete)
    ? dogIdleImg
    : dogWalkImg;

  if (!img || !img.complete) return;

  let sx = 0;
  if (img === dogWalkImg) {
    sx = dog.frame * DOG_FRAME_W;
  }

  const dw = DOG_FRAME_W * DOG_SCALE;
  const dh = DOG_FRAME_H * DOG_SCALE;
  const dx = dog.x - dw / 2;
  const dy = gy - dh;

  ctx.save();

  // art faces LEFT; flip when walking RIGHT
  if (dog.dir === 1) {
    ctx.scale(-1, 1);
    ctx.drawImage(
      img,
      sx, 0, DOG_FRAME_W, DOG_FRAME_H,
      -dx - dw, dy,
      dw, dh
    );
  } else {
    ctx.drawImage(
      img,
      sx, 0, DOG_FRAME_W, DOG_FRAME_H,
      dx, dy,
      dw, dh
    );
  }

  ctx.restore();
}

// ===================================================
// Main loop
// ===================================================
function loop(time){
  const dt = (time - lastTime) / 1000;
  lastTime = time;

  update(dt);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawBackground();
  drawParks();
  drawDog();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
