<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calm Dog — Breathe (1-2-3) then Walk</title>
  <style>
    html,body{margin:0;height:100%;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif;background:#cfe9ff;}
    canvas{display:block;width:100vw;height:100vh;}
    #ui{
      position:fixed;left:12px;top:12px;z-index:10;
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
      background:rgba(255,255,255,.92);box-shadow:0 10px 30px rgba(0,0,0,.18);
      padding:10px 12px;border-radius:16px;
      user-select:none;
    }
    .btn{
      border:none;border-radius:14px;padding:10px 12px;
      font-weight:900;cursor:pointer;background:#ffd166;
    }
    .btn.secondary{background:#e9ecef;}
    .btn.arrow{padding:10px 14px;font-size:18px;line-height:1;}
    #hint{
      position:fixed;left:50%;bottom:14px;transform:translateX(-50%);
      background:rgba(255,255,255,.92);box-shadow:0 10px 30px rgba(0,0,0,.18);
      padding:10px 14px;border-radius:16px;
      font-weight:900;text-align:center;max-width:min(900px, calc(100vw - 24px));
      z-index:10;line-height:1.25;
    }
    #hint small{display:block;font-weight:800;opacity:.75;margin-top:4px;}
    #err{
      position:fixed;left:12px;bottom:12px;z-index:20;
      background:rgba(0,0,0,.75);color:#fff;
      padding:10px 12px;border-radius:12px;
      max-width:min(900px, calc(100vw - 24px));
      font-weight:700;display:none;white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <div id="ui">
    <button class="btn" id="startBtn">Start</button>
    <button class="btn secondary" id="breathBtn">3 Breaths</button>
    <button class="btn secondary" id="muteBtn">Voice: ON</button>
    <button class="btn secondary" id="pauseBtn">Pause</button>
    <button class="btn secondary arrow" id="leftBtn"  title="Hold to move left">◀</button>
    <button class="btn secondary arrow" id="rightBtn" title="Hold to move right">▶</button>
  </div>

  <div id="hint">
    Are you ready to be calm and go for a walk?
    <small>Tap Start (or tap the dog) to begin. Hold ◀ ▶ to move.</small>
  </div>

  <div id="err"></div>
  <canvas id="c"></canvas>

<script>
(() => {
  const errBox = document.getElementById("err");
  function showErr(e){
    errBox.style.display = "block";
    errBox.textContent = "Error:\n" + (e && e.stack ? e.stack : String(e));
  }

  try{
    // ----------------- EDIT YOUR FILE PATHS HERE -----------------
    const ASSETS = {
      bg:   "assets/yosemite.png",  // optional
      idle: "assets/dog_idle.png",
      walk: "assets/dog_walk.png"   // horizontal strip (5 frames recommended)
    };
    const WALK_FRAMES = 5;          // change if your strip is 6, etc.
    // -------------------------------------------------------------

    const canvas = document.getElementById("c");
    const ctx = canvas.getContext("2d");

    const hint = document.getElementById("hint");
    const startBtn = document.getElementById("startBtn");
    const breathBtn = document.getElementById("breathBtn");
    const muteBtn = document.getElementById("muteBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const leftBtn = document.getElementById("leftBtn");
    const rightBtn = document.getElementById("rightBtn");

    function resize(){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      canvas.width  = Math.floor(window.innerWidth  * dpr);
      canvas.height = Math.floor(window.innerHeight * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener("resize", resize);
    resize();

    // -------- Image loader --------
    function loadImage(src){
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => resolve(null);
        img.src = src;
      });
    }

    let bgImg=null, idleImg=null, walkImg=null;
    Promise.all([loadImage(ASSETS.bg), loadImage(ASSETS.idle), loadImage(ASSETS.walk)])
      .then(([bg, idle, walk]) => { bgImg=bg; idleImg=idle; walkImg=walk; });

    // -------- Safe rounded rect --------
    function roundRectPath(x,y,w,h,r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    // -------- Kid-like Dog Voice (queued, no overlap) --------
    const hasSpeech = ("speechSynthesis" in window) && ("SpeechSynthesisUtterance" in window);
    const DOG_VOICE = {
      on: true,
      speaking: false,
      queue: [],
      voice: null,
      // more child-like:
      rate: 0.88,     // slower
      pitch: 1.65     // higher
    };

    function pickDogVoice(){
      if (!hasSpeech) return;
      const vs = speechSynthesis.getVoices?.() || [];
      DOG_VOICE.voice =
        vs.find(v => /en/i.test(v.lang) && /(Samantha|Allison|Ava|Jenny|Aria|Zira|Google)/i.test(v.name)) ||
        vs.find(v => /en/i.test(v.lang)) ||
        vs[0] || null;
    }
    if (hasSpeech){
      try{
        speechSynthesis.onvoiceschanged = pickDogVoice;
        pickDogVoice();
      }catch(e){}
    }

    function dogSay(text, { interrupt=false } = {}){
      if (!DOG_VOICE.on || !hasSpeech) return;
      const cleaned = String(text).replace(/\s+/g," ").trim();
      if (!cleaned) return;

      if (interrupt){
        try{ speechSynthesis.cancel(); }catch(e){}
        DOG_VOICE.queue.length = 0;
        DOG_VOICE.speaking = false;
      }

      // keep phrases short for kids
      DOG_VOICE.queue.push(cleaned);
      if (!DOG_VOICE.speaking) speakNextDog();
    }

    function speakNextDog(){
      const next = DOG_VOICE.queue.shift();
      if (!next){ DOG_VOICE.speaking = false; return; }
      DOG_VOICE.speaking = true;

      try{
        const u = new SpeechSynthesisUtterance(next);
        if (DOG_VOICE.voice) u.voice = DOG_VOICE.voice;
        u.rate = DOG_VOICE.rate;
        u.pitch = DOG_VOICE.pitch;
        u.volume = 1.0;

        u.onend = () => { DOG_VOICE.speaking = false; speakNextDog(); };
        u.onerror = () => { DOG_VOICE.speaking = false; speakNextDog(); };

        speechSynthesis.speak(u);

        // watchdog
        setTimeout(() => {
          if (DOG_VOICE.speaking){
            try{ speechSynthesis.cancel(); }catch(e){}
            DOG_VOICE.speaking = false;
            speakNextDog();
          }
        }, 6500);
      }catch(e){
        DOG_VOICE.speaking = false;
        speakNextDog();
      }
    }

    muteBtn.addEventListener("click", () => {
      DOG_VOICE.on = !DOG_VOICE.on;
      muteBtn.textContent = DOG_VOICE.on ? "Voice: ON" : "Voice: OFF";
      if (!DOG_VOICE.on && hasSpeech){
        try{ speechSynthesis.cancel(); }catch(e){}
        DOG_VOICE.queue.length = 0;
        DOG_VOICE.speaking = false;
      } else {
        dogSay("Woof! Hi!", { interrupt:true });
      }
    });

    // -------- Sprite helpers (no smoosh) --------
    function spriteInfo(img){
      if (!img) return { frames:1, frameW:0, frameH:0 };
      const ratio = img.width / img.height;
      const frames = ratio >= 2.0 ? WALK_FRAMES : 1;
      return { frames, frameW: img.width/frames, frameH: img.height };
    }
    function frameAspect(img){
      if (!img) return 0.80;
      const s = spriteInfo(img);
      const fw = s.frameW || img.width;
      const fh = s.frameH || img.height;
      return fh / fw;
    }
    function drawSprite(img, x, y, drawW, drawH, frameIndex, flipX){
      if (!img){
        // fallback dog so you never get a blank screen
        ctx.save();
        ctx.translate(x,y);
        ctx.fillStyle = "rgba(30,40,60,.88)";
        roundRectPath(-drawW/2, -drawH/2, drawW, drawH, 18);
        ctx.fill();
        ctx.fillStyle = "rgba(255,255,255,.92)";
        ctx.font = "900 18px system-ui, -apple-system, Segoe UI, Arial";
        ctx.textAlign = "center";
        ctx.fillText("DOG", 0, 6);
        ctx.restore();
        return;
      }

      const s = spriteInfo(img);
      const f = s.frames > 1 ? (frameIndex % s.frames) : 0;

      ctx.save();
      ctx.translate(x,y);
      if (flipX) ctx.scale(-1,1);

      const sx = f * s.frameW;
      const sw = s.frameW || img.width;
      const sh = s.frameH || img.height;

      ctx.drawImage(img, sx, 0, sw, sh, -drawW/2, -drawH/2, drawW, drawH);
      ctx.restore();
    }

    // -------- Background + ground --------
    function drawBackground(w,h){
      // soft sky
      ctx.fillStyle = "#cfe9ff";
      ctx.fillRect(0,0,w,h);

      if (bgImg){
        const iw = bgImg.width, ih = bgImg.height;
        const sc = Math.max(w/iw, h/ih);
        const dw = iw*sc, dh = ih*sc;
        ctx.drawImage(bgImg, (w-dw)/2, (h-dh)/2, dw, dh);
        ctx.fillStyle = "rgba(255,255,255,.10)";
        ctx.fillRect(0,0,w,h);
      } else {
        // tiny cloud stripes
        ctx.fillStyle = "rgba(255,255,255,.20)";
        for(let i=0;i<6;i++){
          ctx.beginPath();
          ctx.ellipse(w*(0.15+i*0.15), h*(0.18+(i%2)*0.06), 80, 28, 0, 0, Math.PI*2);
          ctx.fill();
        }
      }

      const groundY = Math.round(h * 0.78);
      ctx.fillStyle = "rgba(30,60,50,.22)";
      ctx.fillRect(0, groundY, w, h-groundY);

      return groundY;
    }

    // -------- Parks / Landmarks --------
    con
