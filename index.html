<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Forever Dog ‚Äî Parks</title>
  <style>
    :root{
      --panel: rgba(255,255,255,.90);
      --shadow: 0 10px 30px rgba(0,0,0,.15);
    }
    html,body{
      margin:0; height:100%; overflow:hidden;
      font-family: system-ui,-apple-system,Segoe UI,Arial,sans-serif;
      background:#bde0fe;
    }
    canvas{ display:block; width:100vw; height:100vh; }

    #controls{
      position:fixed; left:10px; top:10px; z-index:10;
      background:var(--panel);
      padding:8px 10px;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,.2);
      display:flex; gap:6px; flex-wrap:wrap; align-items:center;
      user-select:none;
    }
    button{
      padding:8px 10px; margin:2px;
      border-radius:10px; border:none; cursor:pointer;
      font-weight:700; background:#ffb703;
    }
    button.alt{ background:#8ecae6; }
    button.danger{ background:#fb8500; }

    #msg{
      position:fixed; left:50%; bottom:12px; transform:translateX(-50%);
      background:rgba(255,255,255,.95);
      padding:10px 14px; border-radius:14px;
      box-shadow:0 4px 12px rgba(0,0,0,.2);
      font-weight:800;
      max-width:min(760px, calc(100vw - 24px));
      text-align:center;
      z-index:10;
    }
  </style>
</head>
<body>
  <div id="controls">
    <button class="alt" id="walkL">‚¨ÖÔ∏è Walk</button>
    <button class="alt" id="walkR">Walk ‚û°Ô∏è</button>
    <button class="danger" id="stop">‚èπ Stop</button>
    <button id="pet">ü´∂ Pet</button>
    <button id="feed">ü¶¥ Feed</button>
  </div>

  <div id="msg">Loading‚Ä¶</div>
  <canvas id="c"></canvas>

<script>
(() => {
  // ====== ASSETS (reference version) ======
  const BG_SRC = "assets/yosemite.png";

  const ASSETS = {
    idle:  "assets/dog_idle.png",
    walk:  "assets/dog_walk.png",
    paw:   "assets/dog_paw.png",
    eat:   "assets/dog_eat.png",
    sleep: "assets/dog_sleep.png",
    bark:  "assets/bark.mp3",
  };

  // Reference: 5 frames only (prevents ‚Äúmultiple dogs‚Äù smear)
  const FRAMES = { idle:5, walk:5, paw:5, eat:5, sleep:5 };

  // Landmarks (reference)
  const LANDMARKS = [
    { name:"Tunnel View",     t:0.18 },
    { name:"El Capitan",      t:0.40 },
    { name:"Half Dome",       t:0.62 },
    { name:"Yosemite Falls",  t:0.82 },
  ];

  // ====== CANVAS ======
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  const msgEl = document.getElementById("msg");
  const DPR = window.devicePixelRatio || 1;

  function setMsg(t){ msgEl.textContent = t; }

  function resize(){
    canvas.width  = Math.floor(window.innerWidth  * DPR);
    canvas.height = Math.floor(window.innerHeight * DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  window.addEventListener("resize", resize);
  resize();

  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function coverDraw(img){
    const w = window.innerWidth, h = window.innerHeight;
    const iw = img.naturalWidth || img.width;
    const ih = img.naturalHeight || img.height;
    if (!iw || !ih) return;
    const scale = Math.max(w/iw, h/ih);
    const dw = iw*scale, dh = ih*scale;
    const dx = (w - dw)/2, dy = (h - dh)/2;
    ctx.drawImage(img, dx, dy, dw, dh);
  }

  function roundRect(x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y, x+w,y+h, r);
    ctx.arcTo(x+w,y+h, x,y+h, r);
    ctx.arcTo(x,y+h, x,y, r);
    ctx.arcTo(x,y, x+w,y, r);
    ctx.closePath();
  }

  function drawSign(top, bottom){
    const w = window.innerWidth, h = window.innerHeight;
    const signW = Math.min(520, w - 40);
    const signH = 130;
    const x = (w - signW)/2;
    const y = Math.max(70, h*0.18);

    ctx.save();
    ctx.globalAlpha = 0.95;
    ctx.fillStyle = "rgba(255,255,255,0.92)";
    roundRect(x,y,signW,signH,18);
    ctx.fill();

    ctx.globalAlpha = 1;
    ctx.lineWidth = 3;
    ctx.strokeStyle = "rgba(0,0,0,0.12)";
    roundRect(x,y,signW,signH,18);
    ctx.stroke();

    ctx.fillStyle = "rgba(0,0,0,0.85)";
    ctx.textAlign = "center";
    ctx.font = "800 22px system-ui,-apple-system,Segoe UI,Arial";
    ctx.fillText(top, x + signW/2, y + 52);

    ctx.font = "700 18px system-ui,-apple-system,Segoe UI,Arial";
    ctx.fillText(bottom, x + signW/2, y + 88);
    ctx.restore();
  }

  // ====== SPEECH (stable-ish) ======
  let voices = [];
  function refreshVoices(){ voices = speechSynthesis.getVoices() || []; }
  refreshVoices();
  speechSynthesis.onvoiceschanged = refreshVoices;

  function pickVoice(){
    // Keep this short to avoid ‚Äúdifferent vibe‚Äù bouncing around
    const preferred = ["Samantha","Google US English","Microsoft Zira","Alex"];
    for (const name of preferred){
      const v = voices.find(v => v.name === name);
      if (v) return v;
    }
    return voices.find(v => /en/i.test(v.lang)) || voices[0] || null;
  }

  function speak(text){
    try{
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      const v = pickVoice();
      if (v) u.voice = v;
      u.rate = 1.0;
      u.pitch = 1.05;
      speechSynthesis.speak(u);
    }catch(e){}
  }

  // ====== AUDIO (bark only on pet/feed) ======
  const barkAudio = new Audio(ASSETS.bark);
  barkAudio.volume = 0.55;

  // ====== LOADING ======
  function loadImage(src){
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = () => resolve(null);
      img.src = src;
    });
  }

  class SpriteStrip{
    constructor(img, frames, fps){
      this.img = img;
      this.frames = frames;
      this.fps = fps;
      this.t = 0;
      this.frame = 0;
    }
    reset(){ this.t = 0; this.frame = 0; }
    update(dt){
      this.t += dt;
      this.frame = Math.floor(this.t * this.fps) % this.frames;
    }
    draw(x, y, w, h, flip){
      if (!this.img) return;
      const iw = this.img.naturalWidth || this.img.width;
      const ih = this.img.naturalHeight || this.img.height;
      const fw = iw / this.frames;

      ctx.save();
      ctx.translate(x, y);
      ctx.scale(flip ? -1 : 1, 1);
      ctx.drawImage(
        this.img,
        Math.floor(this.frame * fw), 0, Math.floor(fw), ih,
        -w/2, -h, w, h
      );
      ctx.restore();
    }
  }

  // ====== GAME STATE ======
  const state = {
    t: 0.05,          // 0..1 along trail
    vx: 0,            // -1 left, +1 right
    facingRight: true,
    mode: "idle",     // idle | walk | paw | eat | sleep
    actionUntil: 0,
    arrivedI
