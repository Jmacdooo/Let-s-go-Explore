<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Forever Dog ‚Äî Parks</title>
  <style>
    :root{
      --panel: rgba(255,255,255,.92);
      --shadow: 0 10px 30px rgba(0,0,0,.18);
    }
    html,body{ margin:0; height:100%; overflow:hidden; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; background:#bde0fe; }
    canvas{ display:block; width:100vw; height:100vh; }

    #controls{
      position:fixed; left:12px; top:12px; z-index:10;
      background:var(--panel); box-shadow:var(--shadow);
      padding:10px 12px; border-radius:14px;
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      user-select:none;
    }
    .btn{
      padding:9px 11px; border:none; border-radius:12px; cursor:pointer;
      font-weight:700; background:#ffb703;
    }
    .btn.alt{ background:#8ecae6; }
    .btn.danger{ background:#fb8500; }
    .tiny{ font-size:12px; opacity:.7; font-weight:600; margin-left:6px; }

    #msg{
      position:fixed; left:50%; bottom:12px; transform:translateX(-50%);
      z-index:10;
      background:rgba(255,255,255,.92); box-shadow:var(--shadow);
      padding:10px 14px; border-radius:14px;
      max-width:min(740px, calc(100vw - 24px));
      text-align:center; font-weight:700;
    }

    #debug{
      position:fixed; left:12px; bottom:12px; z-index:10;
      background:rgba(255,255,255,.90); box-shadow:var(--shadow);
      padding:10px 12px; border-radius:14px;
      font: 600 12px/1.25 system-ui,-apple-system,Segoe UI,Arial,sans-serif;
      max-width:min(520px, calc(100vw - 24px));
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <div id="controls">
    <button class="btn alt" id="walkL">‚¨ÖÔ∏è Walk</button>
    <button class="btn alt" id="walkR">Walk ‚û°Ô∏è</button>
    <button class="btn danger" id="stop">‚èπ Stop</button>

    <button class="btn" id="pet">ü´∂ Pet</button>
    <button class="btn" id="feed">ü¶¥ Feed</button>
    <button class="btn alt" id="sleep">üò¥ Sleep</button>

    <span class="tiny">Walk to the sign to ‚Äúarrive‚Äù at a landmark.</span>
  </div>

  <div id="msg">Loading‚Ä¶</div>
  <div id="debug">Debug loading‚Ä¶</div>
  <canvas id="c"></canvas>

<script>
(() => {
  // ------------------ EDIT ONLY IF YOU WANT ------------------
  // Put your Half Dome image at one of these paths (any one works):
  // assets/half_dome.png  OR  assets/parks/half_dome.png
  const HALF_DOME_FILE_HINT = "half_dome.png"; // just a hint for candidates

  // ------------------ CANVAS SETUP ------------------
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  const msgEl = document.getElementById("msg");
  const dbgEl = document.getElementById("debug");

  function setMsg(t){ msgEl.textContent = t; }
  function setDbg(t){ dbgEl.textContent = t; }

  function resize(){
    canvas.width  = Math.floor(window.innerWidth  * devicePixelRatio);
    canvas.height = Math.floor(window.innerHeight * devicePixelRatio);
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }
  window.addEventListener("resize", resize);
  resize();

  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function coverDraw(img){
    const w = window.innerWidth, h = window.innerHeight;
    const iw = img.naturalWidth || img.width, ih = img.naturalHeight || img.height;
    if (!iw || !ih) return;
    const scale = Math.max(w/iw, h/ih);
    const dw = iw * scale, dh = ih * scale;
    const dx = (w - dw) / 2, dy = (h - dh) / 2;
    ctx.drawImage(img, dx, dy, dw, dh);
  }

  function roundRect(x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y, x+w,y+h, r);
    ctx.arcTo(x+w,y+h, x,y+h, r);
    ctx.arcTo(x,y+h, x,y, r);
    ctx.arcTo(x,y, x+w,y, r);
    ctx.closePath();
  }

  function drawSign(textTop, textBottom){
    const w = window.innerWidth, h = window.innerHeight;
    const signW = Math.min(520, w - 40);
    const signH = 130;
    const x = (w - signW)/2;
    const y = Math.max(70, h*0.18);

    ctx.save();
    ctx.globalAlpha = 0.95;
    ctx.fillStyle = "rgba(255,255,255,0.92)";
    roundRect(x, y, signW, signH, 18);
    ctx.fill();
    ctx.globalAlpha = 1;
    ctx.lineWidth = 3;
    ctx.strokeStyle = "rgba(0,0,0,0.12)";
    roundRect(x, y, signW, signH, 18);
    ctx.stroke();

    ctx.fillStyle = "rgba(0,0,0,0.85)";
    ctx.font = "800 22px system-ui,-apple-system,Segoe UI,Arial";
    ctx.textAlign = "center";
    ctx.fillText(textTop, x + signW/2, y + 52);
    ctx.font = "700 18px system-ui,-apple-system,Segoe UI,Arial";
    ctx.fillText(textBottom, x + signW/2, y + 88);
    ctx.restore();
  }

  // ------------------ ASSET LOADING (tries multiple paths) ------------------
  function loadImage(src){
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => resolve({ok:true, img, src});
      img.onerror = () => resolve({ok:false, img:null, src});
      img.src = src;
    });
  }

  async function loadFirst(label, candidates){
    for (const p of candidates){
      const r = await loadImage(p);
      if (r.ok) return {ok:true, img:r.img, src:r.src, label, tried:candidates};
    }
    return {ok:false, img:null, src:null, label, tried:candidates};
  }

  // Common locations (your repo has these at /assets/* at the top level)
  const PATHS = {
    idle:  ["assets/dog_idle.png","./assets/dog_idle.png","assets/dog/dog_idle.png","/assets/dog_idle.png"],
    walk:  ["assets/dog_walk.png","./assets/dog_walk.png","assets/dog/dog_walk.png","/assets/dog_walk.png"],
    paw:   ["assets/dog_paw.png","./assets/dog_paw.png","assets/dog/dog_paw.png","/assets/dog_paw.png"],
    eat:   ["assets/dog_eat.png","./assets/dog_eat.png","assets/dog/dog_eat.png","/assets/dog_eat.png"],
    sleep: ["assets/dog_sleep.png","./assets/dog_sleep.png","assets/dog/dog_sleep.png","/assets/dog_sleep.png"],

    // Yosemite background candidates (you‚Äôve used yosemite.png at assets root)
    yose: [
      "assets/yosemite.png","./assets/yosemite.png","/assets/yosemite.png",
      "assets/parks/yosemite.png","assets/parks/bg_yose.png","assets/parks/bg_yose (1).png"
    ],

    // Half Dome background candidates
    half: [
      `assets/${HALF_DOME_FILE_HINT}`, `./assets/${HALF_DOME_FILE_HINT}`, `/assets/${HALF_DOME_FILE_HINT}`,
      `assets/parks/${HALF_DOME_FILE_HINT}`, `assets/parks/half_dome.png`, `assets/half_dome.jpg`, `assets/parks/half_dome.jpg`
    ],
  };

  // ------------------ AUDIO + SPEECH (bark ONLY on pet/feed) ------------------
  const barkAudio = new Audio("assets/bark.mp3");
  barkAudio.volume = 0.55;

  let voices = [];
  function loadVoices(){ voices = speechSynthesis.getVoices() || []; }
  loadVoices();
  window.speechSynthesis.onvoiceschanged = loadVoices;

  function speak(text){
    try{
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      const v = voices.find(v => /en/i.test(v.lang)) || voices[0];
      if (v) u.voice = v;
      u.rate = 1.0; u.pitch = 1.05;
      speechSynthesis.speak(u);
    }catch(e){}
  }

  // ------------------ SPRITES ------------------
  function detectFrames(img, fallback=5){
    const iw = img?.naturalWidth || img?.width || 0;
    const ih = img?.naturalHeight || img?.height || 0;
    if (!iw || !ih) return fallback;

    const ratio = iw / ih;           // strips are usually N frames wide, 1 frame tall (square-ish)
    const guess = Math.round(ratio); // nearest integer
    if (guess >= 1 && guess <= 12 && Math.abs(ratio - guess) < 0.25) return guess;
    return fallback;
  }

  class Sprite {
    constructor(img, fps){
      this.img = img;
      this.fps = fps;
      this.frames = img ? detectFrames(img, 5) : 1;
      this.t = 0;
      this.frame = 0;
    }
    reset(){ this.t = 0; this.frame = 0; }
    update(dt){
      if (!this.img) return;
      this.t += dt;
      this.frame = Math.floor(this.t * this.fps) % this.frames;
    }
    draw(x, y, w, h, flip){
      if (!this.img) return;
      const iw = this.img.naturalWidth || this.img.width;
      const ih = this.img.naturalHeight || this.img.height;
      const fw = iw / this.frames;

      ctx.save();
      ctx.translate(x, y);
      ctx.scale(flip ? -1 : 1, 1);
      ctx.drawImage(
        this.img,
        Math.floor(this.frame * fw), 0, Math.floor(fw), ih,
        -w/2, -h, w, h
      );
      ctx.restore();
    }
  }

  // ------------------ GAME STATE ------------------
  const state = {
    dogT: 0.05,
    vx: 0,
    facingRight: true,
    mode: "idle",
    actionUntil: 0,
    arrivedIndex: -999,
    bgImg: null,
    bgHalfImg: null,
  };

  const SPEED = 0.10;
  const ARRIVE_RANGE = 0.025;

  let LANDMARKS = [
    { name: "Tunnel View",    t: 0.18, bg: "yose" },
    { name: "El Capitan",     t: 0.40, bg: "yose" },
    { name: "Half Dome",      t: 0.62, bg: "half" }, // swaps background here
    { name: "Yosemite Falls", t: 0.82, bg: "yose" },
  ];

  function getCurrentLandmarkIndex(){
    for (let i=0;i<LANDMARKS.length;i++){
      if (Math.abs(state.dogT - LANDMARKS[i].t) <= ARRIVE_RANGE) return i;
    }
    return -1;
  }

  // ------------------ UI ------------------
  document.getElementById("walkL").onclick = () => { if (state.mode !== "sleep"){ state.vx = -1; state.facingRight = false; } };
  document.getElementById("walkR").onclick = () => { if (state.mode !== "sleep"){ state.vx =  1; state.facingRight = true;  } };
  document.getElementById("stop").onclick  = () => { state.vx = 0; };

  document.getElementById("pet").onclick = () => {
    if (state.mode === "sleep") return;
    barkAudio.currentTime = 0; barkAudio.play().catch(()=>{});
    state.mode = "paw"; state.actionUntil = performance.now() + 750;
    sprites.paw.reset();
    setMsg("Awww. Good pup! ü´∂");
    speak("Who's a good dog?");
  };

  document.getElementById("feed").onclick = () => {
    if (state.mode === "sleep") return;
    barkAudio.currentTime = 0; barkAudio.play().catch(()=>{});
    state.mode = "eat"; state.actionUntil = performance.now() + 900;
    sprites.eat.reset();
    setMsg("Crunch crunch. ü¶¥");
    speak("Yum!");
  };

  document.getElementById("sleep").onclick = () => {
    if (state.mode === "sleep") {
      state.mode = "idle";
      setMsg("Up we go! ‚òÄÔ∏è");
      speak("I'm awake!");
    } else {
      state.vx = 0;
      state.mode = "sleep";
      sprites.sleep.reset();
      setMsg("Zzz‚Ä¶ üò¥");
      speak("Goodnight.");
    }
  };

  // ------------------ LOADING ------------------
  let sprites = {};
  let bgYose = null;
  let bgHalf = null;

  async function boot(){
    setMsg("Loading dog + backgrounds‚Ä¶");

    const results = await Promise.all([
      loadFirst("dog_idle",  PATHS.idle),
      loadFirst("dog_walk",  PATHS.walk),
      loadFirst("dog_paw",   PATHS.paw),
      loadFirst("dog_eat",   PATHS.eat),
      loadFirst("dog_sleep", PATHS.sleep),
      loadFirst("yosemite_bg", PATHS.yose),
      loadFirst("half_dome_bg", PATHS.half),
    ]);

    const loaded = [];
    const missing = [];

    for (const r of results){
      if (r.ok) loaded.push(`${r.label}: ${r.src}`);
      else missing.push(`${r.label}: tried ‚Üí ${r.tried.join(", ")}`);
    }

    // Build sprites (even if some missing, we‚Äôll still run)
    const idleImg  = results[0].img;
    const walkImg  = results[1].img;
    const pawImg   = results[2].img;
    const eatImg   = results[3].img;
    const sleepImg = results[4].img;

    bgYose = results[5].img;
    bgHalf = results[6].img;

    sprites = {
      idle:  new Sprite(idleImg,  6),
      walk:  new Sprite(walkImg, 10),
      paw:   new Sprite(pawImg,  10),
      eat:   new Sprite(eatImg,  10),
      sleep: new Sprite(sleepImg, 5),
    };

    // Debug panel
    setDbg(
      `LOADED:\n- ${loaded.join("\n- ")}` +
      (missing.length ? `\n\nMISSING (this is why the dog can be invisible):\n- ${missing.join("\n- ")}` : "") +
      `\n\nSprite frames detected:\n- idle: ${sprites.idle.frames}\n- walk: ${sprites.walk.frames}\n- paw: ${sprites.paw.frames}\n- eat: ${sprites.eat.frames}\n- sleep: ${sprites.sleep.frames}`
    );

    // If the dog is missing, scream it in the main message too.
    const dogOk = !!(idleImg || walkImg || pawImg || eatImg || sleepImg);
    if (!dogOk){
      setMsg("Dog images are NOT loading. Look at the debug box (missing paths).");
    } else {
      setMsg("Walk around Yosemite! üêæ (Half Dome swaps the background.)");
    }

    requestAnimationFrame(loop);
  }

  // ------------------ DRAW ------------------
  function drawPlaceholderDog(x, y){
    // simple ‚Äúdog blob‚Äù so you see *something* even if PNGs are missing
    ctx.save();
    ctx.translate(x, y);
    ctx.fillStyle = "rgba(0,0,0,0.20)";
    ctx.beginPath();
    ctx.ellipse(0, -55, 55, 35, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = "rgba(255,255,255,0.85)";
    ctx.beginPath();
    ctx.ellipse(-10, -65, 7, 7, 0, 0, Math.PI*2);
    ctx.ellipse( 10, -65, 7, 7, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  function draw(){
    const w = window.innerWidth, h = window.innerHeight;

    // choose background
    const idx = getCurrentLandmarkIndex();
    const atHalfDome = (idx >= 0 && LANDMARKS[idx].name === "Half Dome" && bgHalf);
    const bg = atHalfDome ? bgHalf : bgYose;

    ctx.clearRect(0,0,w,h);
    if (bg) coverDraw(bg);
    else {
      ctx.fillStyle = "#bde0fe";
      ctx.fillRect(0,0,w,h);
    }

    // ground
    const groundY = Math.floor(h * 0.86);
    ctx.save();
    ctx.strokeStyle = "rgba(0,0,0,0.15)";
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(0, groundY);
    ctx.lineTo(w, groundY);
    ctx.stroke();
    ctx.restore();

    // dog
    const x = w * (0.08 + state.dogT * 0.84);
    const dogW = Math.min(260, w * 0.18);
    const dogH = dogW;

    let spr = sprites.idle;
    if (state.mode === "walk") spr = sprites.walk;
    if (state.mode === "paw")  spr = sprites.paw;
    if (state.mode === "eat")  spr = sprites.eat;
    if (state.mode === "sleep")spr = sprites.sleep;

    if (spr && spr.img){
      spr.draw(x, groundY, dogW, dogH, !state.facingRight);
    } else {
      drawPlaceholderDog(x, groundY);
    }

    // sign if close
    if (idx >= 0){
      drawSign(LANDMARKS[idx].name, `Landmark ${idx + 1} of ${LANDMARKS.length}`);
    }
  }

  // ------------------ UPDATE LOOP ------------------
  let last = performance.now();
  function loop(now){
    const dt = Math.min(0.05, (now - last) / 1000);
    last = now;

    if ((state.mode === "paw" || state.mode === "eat") && now >= state.actionUntil){
      state.mode = (state.vx !== 0) ? "walk" : "idle";
    }

    if (state.mode !== "sleep" && state.vx !== 0 && !(state.mode === "paw" || state.mode === "eat")){
      state.mode = "walk";
      state.dogT = clamp(state.dogT + state.vx * SPEED * dt, 0, 1);
    } else if (!(state.mode === "paw" || state.mode === "eat" || state.mode === "sleep")){
      state.mode = "idle";
    }

    // update sprites
    for (const k in sprites) sprites[k].update(dt);

    // message on landmark changes
    const idx = getCurrentLandmarkIndex();
    if (idx !== state.arrivedIndex){
      state.arrivedIndex = idx;
      if (idx >= 0){
        setMsg(`Arrived: ${LANDMARKS[idx].name} ‚Äî Landmark ${idx + 1} of ${LANDMARKS.length}`);
        speak(LANDMARKS[idx].name);
      } else {
        setMsg("Exploring Yosemite‚Ä¶ üêæ");
      }
    }

    draw();
    requestAnimationFrame(loop);
  }

  boot();
})();
</script>
</body>
</html>
