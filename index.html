<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>My Forever Dog ‚Äî Simple Working Version</title>
<style>
  html,body{
    margin:0;
    height:100%;
    overflow:hidden;
    font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif;
    background:#cfe9ff; /* blue, not black */
  }
  canvas{
    display:block;
    width:100vw;
    height:100vh;
  }
  #ui{
    position:fixed;
    left:12px;
    top:12px;
    z-index:10;
    background:rgba(255,255,255,.92);
    box-shadow:0 10px 30px rgba(0,0,0,.15);
    border-radius:14px;
    padding:10px 12px;
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
    font-size:12px;
  }
  #ui b{font-size:13px}
  #ui .pill{
    background:#fff;
    border:1px solid rgba(0,0,0,.12);
    border-radius:999px;
    padding:6px 10px;
  }
  #ui button{
    border:none;
    border-radius:10px;
    padding:8px 10px;
    background:#111;
    color:#fff;
    font-weight:700;
    cursor:pointer;
  }
  #ui button.secondary{
    background:#fff;
    color:#111;
    border:1px solid rgba(0,0,0,.15);
  }
</style>
</head>
<body>

<div id="ui">
  <b>üêæ My Forever Dog</b>
  <span class="pill">Move: Arrows / WASD</span>
  <span class="pill">Shift = run</span>
  <span class="pill">Tap dog = pet (later)</span>
  <button id="btnFeed" class="secondary">Feed</button>
  <button id="btnPet"  class="secondary">Pet</button>
  <button id="btnSleep"class="secondary">Sleep</button>
  <button id="btnReset"class="secondary">Reset</button>
  <span class="pill">Frames: <b id="framesLabel">6</b></span>
</div>

<canvas id="game"></canvas>

<script>
/* =========================
   CANVAS
========================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d", { alpha:true });

function resize(){
  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  canvas.width  = Math.floor(innerWidth  * dpr);
  canvas.height = Math.floor(innerHeight * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
addEventListener("resize", resize);
resize();

/* =========================
   WORLD / GROUND
========================= */
const WORLD_W = 2600;
const WORLD_H = 1400;
const GROUND_Y = 980;
const DOG_FOOT_OFFSET = 8;

const camera = { x:0, y:0 };
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));

/* =========================
   INPUT
========================= */
const keys = new Set();
addEventListener("keydown",(e)=>{
  const k = e.key.toLowerCase();
  keys.add(k);
  if(["arrowup","arrowdown","arrowleft","arrowright"," "].includes(k)) e.preventDefault();
},{passive:false});
addEventListener("keyup",(e)=>keys.delete(e.key.toLowerCase()));

/* =========================
   DOG SPRITE
========================= */
let FRAME_COUNT = 6;
document.getElementById("framesLabel").textContent = FRAME_COUNT;

let sheet = null;
let frameW = 0, frameH = 0;

function loadImage(src){
  return new Promise((resolve,reject)=>{
    const im = new Image();
    im.onload = ()=>resolve(im);
    im.onerror = ()=>reject(new Error("Failed to load "+src));
    im.src = src + "?v=" + Date.now();
  });
}

// Crop big transparent margins so dog isn‚Äôt tiny/high
function cropTransparentMargins(img){
  const w = img.naturalWidth || img.width;
  const h = img.naturalHeight || img.height;

  const off = document.createElement("canvas");
  off.width = w; off.height = h;
  const octx = off.getContext("2d", { willReadFrequently:true });
  octx.drawImage(img,0,0);

  const data = octx.getImageData(0,0,w,h).data;
  let minX=w, minY=h, maxX=0, maxY=0, found=false;

  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const a = data[(y*w + x)*4 + 3];
      if(a>5){
        found=true;
        if(x<minX)minX=x;
        if(y<minY)minY=y;
        if(x>maxX)maxX=x;
        if(y>maxY)maxY=y;
      }
    }
  }
  if(!found) return off;

  const pad=6;
  minX=Math.max(0,minX-pad); minY=Math.max(0,minY-pad);
  maxX=Math.min(w-1,maxX+pad); maxY=Math.min(h-1,maxY+pad);

  const cw=maxX-minX+1, ch=maxY-minY+1;
  const cropped=document.createElement("canvas");
  cropped.width=cw; cropped.height=ch;
  cropped.getContext("2d").drawImage(off,minX,minY,cw,ch,0,0,cw,ch);
  return cropped;
}

async function loadDog(){
  // IMPORTANT: this matches your repo: index.html in root, PNG in /assets/
  const img = await loadImage("assets/dog_walk.png");
  sheet = cropTransparentMargins(img);
  frameW = Math.floor(sheet.width / FRAME_COUNT);
  frameH = sheet.height;
}

/* =========================
   DOG ENTITY
========================= */
const dog = {
  x: WORLD_W/2,
  y: GROUND_Y,
  vx: 0, vy: 0,
  facing: 1,
  frame: 0,
  animT: 0,
  speed: 320,
  runMult: 1.75,
  mood: "idle" // idle | happy | sleepy | full
};

/* =========================
   UPDATE
========================= */
let last = performance.now();

function update(dt){
  const left  = keys.has("arrowleft")  || keys.has("a");
  const right = keys.has("arrowright") || keys.has("d");
  const up    = keys.has("arrowup")    || keys.has("w");
  const down  = keys.has("arrowdown")  || keys.has("s");
  const run   = keys.has("shift");

  let ax = 0, ay = 0;
  if(left) ax -= 1;
  if(right) ax += 1;
  if(up) ay -= 1;
  if(down) ay += 1;

  const mag = Math.hypot(ax,ay) || 1;
  ax /= mag; ay /= mag;

  const spd = dog.speed * (run ? dog.runMult : 1);
  dog.vx = ax * spd;
  dog.vy = ay * spd;

  dog.x += dog.vx * dt;
  dog.y += dog.vy * dt;

  dog.x = clamp(dog.x, 60, WORLD_W-60);
  dog.y = clamp(dog.y, GROUND_Y-120, GROUND_Y+120);

  if(dog.vx > 6) dog.facing = 1;
  if(dog.vx < -6) dog.facing = -1;

  const moving = (Math.abs(dog.vx) + Math.abs(dog.vy)) > 2;

  // simple ‚Äúsleepy‚Äù mood if idle too long
  if(!moving){
    dog._idleT = (dog._idleT || 0) + dt;
    if(dog._idleT > 6 && dog.mood !== "sleepy"){
      dog.mood = "sleepy";
    }
  } else {
    dog._idleT = 0;
  }

  if(sheet && frameW>0 && moving){
    dog.animT += dt;
    const fps = run ? 16 : 12;
    if(dog.animT >= 1/fps){
      dog.animT = 0;
      dog.frame = (dog.frame + 1) % FRAME_COUNT;
    }
  } else {
    dog.frame = 0;
  }

  camera.x = clamp(dog.x - innerWidth/2, 0, WORLD_W - innerWidth);
  camera.y = clamp(dog.y - innerHeight/2, 0, WORLD_H - innerHeight);
}

/* =========================
   DRAW
========================= */
function draw(){
  ctx.clearRect(0,0,innerWidth,innerHeight);

  // sky
  ctx.fillStyle = "#bfe3ff";
  ctx.fillRect(0,0,innerWidth,innerHeight);

  ctx.save();
  ctx.translate(-camera.x, -camera.y);

  // soft hills
  ctx.fillStyle = "rgba(0,0,0,.06)";
  for(let i=0;i<6;i++){
    ctx.beginPath();
    ctx.ellipse(250 + i*520, 260, 520, 160, 0, 0, Math.PI*2);
    ctx.fill();
  }

  // ground
  ctx.fillStyle = "rgba(0,0,0,.10)";
  ctx.fillRect(0, GROUND_Y+40, WORLD_W, WORLD_H-(GROUND_Y+40));
  ctx.fillStyle = "rgba(255,255,255,.22)";
  ctx.fillRect(0, GROUND_Y+10, WORLD_W, 24);

  drawDog();

  ctx.restore();
}

function drawDog(){
  const px = dog.x;
  const py = dog.y;

  if(!sheet || frameW<=0){
    ctx.fillStyle = "rgba(0,0,0,.35)";
    ctx.beginPath(); ctx.arc(px, py, 26, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "#fff";
    ctx.font = "12px system-ui";
    ctx.fillText("loading assets/dog_walk.png...", px-90, py-40);
    return;
  }

  const targetH = 150;
  const scale = targetH / frameH;
  const drawW = frameW * scale;
  const drawH = frameH * scale;

  const dx = px - drawW/2;
  const dy = (py - drawH) + DOG_FOOT_OFFSET;

  const sx = dog.frame * frameW;
  const sy = 0;

  ctx.save();
  if(dog.facing === -1){
    ctx.translate(px, 0);
    ctx.scale(-1, 1);
    ctx.translate(-px, 0);
  }
  ctx.imageSmoothingEnabled = true;
  ctx.drawImage(sheet, sx, sy, frameW, frameH, dx, dy, drawW, drawH);
  ctx.restore();
}

/* =========================
   LOOP
========================= */
function loop(now){
  const dt = Math.min(0.033, (now - last)/1000);
  last = now;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}

/* =========================
   BUTTONS
========================= */
document.getElementById("btnFeed").addEventListener("click", ()=>{
  dog.mood = "full";
  console.log("Feed clicked");
});
document.getElementById("btnPet").addEventListener("click", ()=>{
  dog.mood = "happy";
  console.log("Pet clicked");
});
document.getElementById("btnSleep").addEventListener("click", ()=>{
  dog.mood = "sleepy";
  console.log("Sleep clicked");
});
document.getElementById("btnReset").addEventListener("click", ()=>{
  dog.x = WORLD_W/2;
  dog.y = GROUND_Y;
  dog.vx = dog.vy = 0;
  dog.facing = 1;
  dog.frame = 0;
  dog.mood = "idle";
});

/* =========================
   START
========================= */
(async function start(){
  try{
    await loadDog();
    requestAnimationFrame(loop);
  }catch(err){
    console.error(err);
    alert("Could not load assets/dog_walk.png ‚Äî check the filename in /assets/");
  }
})();
</script>
</body>
</html>

