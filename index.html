<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Forever Dog ‚Äî Parks</title>
  <style>
    :root{
      --panel: rgba(255,255,255,.90);
      --shadow: 0 10px 30px rgba(0,0,0,.15);
    }
    html,body{
      margin:0; height:100%; overflow:hidden;
      font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background:#cfe9ff;
    }
    canvas{ display:block; width:100vw; height:100vh; }

    #controls{
      position:fixed; left:12px; top:12px; z-index:10;
      background:var(--panel);
      box-shadow:var(--shadow);
      padding:10px 12px;
      border-radius:14px;
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      user-select:none;
    }
    button{
      padding:8px 10px; border-radius:12px; border:none; cursor:pointer;
      font-weight:800;
      background:#ffb703;
    }
    button.alt{ background:#8ecae6; }
    button.danger{ background:#fb8500; }
    #msg{
      position:fixed; left:50%; bottom:12px; transform:translateX(-50%);
      background:rgba(255,255,255,.92);
      box-shadow:var(--shadow);
      padding:10px 14px; border-radius:14px;
      font-weight:800;
      max-width:min(760px, calc(100vw - 24px));
      text-align:center;
      z-index:10;
    }
  </style>
</head>
<body>
  <div id="controls">
    <button class="alt" id="walkL">‚¨ÖÔ∏è Walk</button>
    <button class="alt" id="walkR">Walk ‚û°Ô∏è</button>
    <button class="danger" id="stop">‚èπ Stop</button>
    <button id="pet">ü´∂ Pet</button>
    <button id="feed">ü¶¥ Feed</button>
    <button class="alt" id="sleep">üò¥ Sleep</button>
  </div>

  <div id="msg">Loading‚Ä¶</div>
  <canvas id="c"></canvas>

<script>
(() => {
  // ===== ASSETS (this matches your repo layout) =====
  const BG_SRC = "assets/yosemite.png";

  const ASSETS = {
    idle:  "assets/dog_idle.png",
    walk:  "assets/dog_walk.png",
    paw:   "assets/dog_paw.png",
    eat:   "assets/dog_eat.png",
    sleep: "assets/dog_sleep.png",
    bark:  "assets/bark.mp3",
  };

  // IMPORTANT: 5 frames (prevents ‚Äúmultiple dogs‚Äù / strip smear)
  const FRAMES = { idle:5, walk:5, paw:5, eat:5, sleep:5 };

  // Landmarks along the trail (0..1)
  const LANDMARKS = [
    { name:"Tunnel View",     t:0.18 },
    { name:"El Capitan",      t:0.40 },
    { name:"Half Dome",       t:0.62 },
    { name:"Yosemite Falls",  t:0.82 },
  ];

  // ===== CANVAS =====
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  const msgEl = document.getElementById("msg");
  const DPR = window.devicePixelRatio || 1;

  function setMsg(t){ msgEl.textContent = t; }

  function resize(){
    canvas.width  = Math.floor(window.innerWidth  * DPR);
    canvas.height = Math.floor(window.innerHeight * DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  window.addEventListener("resize", resize);
  resize();

  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function coverDraw(img){
    const w = window.innerWidth, h = window.innerHeight;
    const iw = img.naturalWidth || img.width;
    const ih = img.naturalHeight || img.height;
    if (!iw || !ih) return;
    const scale = Math.max(w/iw, h/ih);
    const dw = iw*scale, dh = ih*scale;
    const dx = (w - dw)/2, dy = (h - dh)/2;
    ctx.drawImage(img, dx, dy, dw, dh);
  }

  function roundRect(x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y, x+w,y+h, r);
    ctx.arcTo(x+w,y+h, x,y+h, r);
    ctx.arcTo(x,y+h, x,y, r);
    ctx.arcTo(x,y, x+w,y, r);
    ctx.closePath();
  }

  function drawSign(top, bottom){
    const w = window.innerWidth, h = window.innerHeight;
    const signW = Math.min(520, w - 40);
    const signH = 130;
    const x = (w - signW)/2;
    const y = Math.max(70, h*0.18);

    ctx.save();
    ctx.globalAlpha = 0.95;
    ctx.fillStyle = "rgba(255,255,255,0.92)";
    roundRect(x,y,signW,signH,18);
    ctx.fill();

    ctx.globalAlpha = 1;
    ctx.lineWidth = 3;
    ctx.strokeStyle = "rgba(0,0,0,0.12)";
    roundRect(x,y,signW,signH,18);
    ctx.stroke();

    ctx.fillStyle = "rgba(0,0,0,0.85)";
    ctx.textAlign = "center";
    ctx.font = "800 22px system-ui,-apple-system,Segoe UI,Arial";
    ctx.fillText(top, x + signW/2, y + 52);

    ctx.font = "700 18px system-ui,-apple-system,Segoe UI,Arial";
    ctx.fillText(bottom, x + signW/2, y + 88);
    ctx.restore();
  }

  // ===== SPEECH (more consistent voice choice) =====
  let voices = [];
  function refreshVoices(){
    voices = speechSynthesis.getVoices() || [];
  }
  refreshVoices();
  speechSynthesis.onvoiceschanged = refreshVoices;

  function pickVoice(){
    // Prefer these if present (varies by browser/OS)
    const preferred = [
      "Samantha",
      "Google US English",
      "Google UK English Female",
      "Microsoft Zira",
      "Microsoft Jenny",
      "Microsoft Aria",
      "Alex",
    ];

    for (const name of preferred){
      const v = voices.find(v => v.name === name);
      if (v) return v;
    }
    return voices.find(v => /en/i.test(v.lang)) || voices[0] || null;
  }

  function speak(text){
    try{
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      const v = pickVoice();
      if (v) u.voice = v;
      u.rate = 1.0;
      u.pitch = 1.05;
      speechSynthesis.speak(u);
    }catch(e){}
  }

  // ===== AUDIO (bark only on pet/feed) =====
  const barkAudio = new Audio(ASSETS.bark);
  barkAudio.volume = 0.55;

  // ===== LOADING =====
  function loadImage(src){
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = () => resolve(null);
      img.src = src;
    });
  }

  class SpriteStrip {
    constructor(img, frames, fps){
      this.img = img;
      this.frames = frames;
      this.fps = fps;
      this.t = 0;
      this.frame = 0;
    }
    reset(){ this.t = 0; this.frame = 0; }
    update(dt){
      this.t += dt;
      this.frame = Math.floor(this.t * this.fps) % this.frames;
    }
    draw(x, y, w, h, flip){
      if (!this.img) return;
      const iw = this.img.naturalWidth || this.img.width;
      const ih = this.img.naturalHeight || this.img.height;
      const fw = iw / this.frames;

      ctx.save();
      ctx.translate(x, y);
      ctx.scale(flip ? -1 : 1, 1);

      ctx.drawImage(
        this.img,
        Math.floor(this.frame * fw), 0, Math.floor(fw), ih,
        -w/2, -h, w, h
      );

      ctx.restore();
    }
  }

  const state = {
    t: 0.05,             // trail position 0..1
    vx: 0,               // -1,0,1
    facingRight: true,
    mode: "idle",        // idle|walk|paw|eat|sleep
    actionUntil: 0,
    arrivedIndex: -1,
  };

  const SPEED = 0.10;         // trail units / sec
  const ARRIVE_RANGE = 0.025; // closeness for ‚Äúarrive‚Äù

  function currentLandmarkIndex(){
    for (let i=0;i<LANDMARKS.length;i++){
      if (Math.abs(state.t - LANDMARKS[i].t) <= ARRIVE_RANGE) return i;
    }
    return -1;
  }

  // ===== UI =====
  document.getElementById("walkL").onclick = () => {
    if (state.mode === "sleep") return;
    state.vx = -1;
    state.facingRight = false;
  };
  document.getElementById("walkR").onclick = () => {
    if (state.mode === "sleep") return;
    state.vx = 1;
    state.facingRight = true;
  };
  document.getElementById("stop").onclick = () => { state.vx = 0; };

  document.getElementById("pet").onclick = () => {
    if (state.mode === "sleep") return;
    barkAudio.currentTime = 0; barkAudio.play().catch(()=>{});
    state.mode = "paw";
    state.actionUntil = performance.now() + 750;
    sprites.paw.reset();
    setMsg("Awww. Good pup! ü´∂");
    speak("Who's a good dog?");
  };

  document.getElementById("feed").onclick = () => {
    if (state.mode === "sleep") return;
    barkAudio.currentTime = 0; barkAudio.play().catch(()=>{});
    state.mode = "eat";
    state.actionUntil = performance.now() + 900;
    sprites.eat.reset();
    setMsg("Crunch crunch. ü¶¥");
    speak("Yum!");
  };

  document.getElementById("sleep").onclick = () => {
    if (state.mode === "sleep"){
      state.mode = "idle";
      setMsg("Up we go! ‚òÄÔ∏è");
      speak("I'm awake!");
    } else {
      state.vx = 0;
      state.mode = "sleep";
      sprites.sleep.reset();
      setMsg("Zzz‚Ä¶ üò¥");
      speak("Goodnight.");
    }
  };

  // ===== BOOT + LOOP =====
  let bgImg = null;
  let sprites = {};

  async function boot(){
    setMsg("Loading Yosemite + dog‚Ä¶");

    const [bg, idle, walk, paw, eat, sleep] = await Promise.all([
      loadImage(BG_SRC),
      loadImage(ASSETS.idle),
      loadImage(ASSETS.walk),
      loadImage(ASSETS.paw),
      loadImage(ASSETS.eat),
      loadImage(ASSETS.sleep),
    ]);

    bgImg = bg;

    sprites = {
      idle:  new SpriteStrip(idle,  FRAMES.idle,  6),
      walk:  new SpriteStrip(walk,  FRAMES.walk,  10),
      paw:   new SpriteStrip(paw,   FRAMES.paw,   10),
      eat:   new SpriteStrip(eat,   FRAMES.eat,   10),
      sleep: new SpriteStrip(sleep, FRAMES.sleep, 5),
    };

    if (!sprites.idle.img && !sprites.walk.img){
      setMsg("Dog images not loading ‚Äî check filenames/paths in /assets.");
    } else {
      setMsg("Walk around Yosemite! üêæ");
    }

    requestAnimationFrame(loop);
  }

  function draw(){
    const w = window.innerWidth, h = window.innerHeight;

    ctx.clearRect(0,0,w,h);
    if (bgImg) coverDraw(bgImg);
    else {
      ctx.fillStyle = "#cfe9ff";
      ctx.fillRect(0,0,w,h);
    }

    // ground line
    const groundY = Math.floor(h * 0.86);
    ctx.save();
    ctx.strokeStyle = "rgba(0,0,0,0.15)";
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(0, groundY);
    ctx.lineTo(w, groundY);
    ctx.stroke();
    ctx.restore();

    // dog position
    const x = w * (0.08 + state.t * 0.84);
    const dogW = Math.min(260, w * 0.18);
    const dogH = dogW;

    let spr = sprites.idle;
    if (state.mode === "walk") spr = sprites.walk;
    if (state.mode === "paw")  spr = sprites.paw;
    if (state.mode === "eat")  spr = sprites.eat;
    if (state.mode === "sleep")spr = sprites.sleep;

    // draw dog (single draw, no duplicates)
    if (spr) spr.draw(x, groundY, dogW, dogH, !state.facingRight);

    // sign near landmarks
    const idx = currentLandmarkIndex();
    if (idx >= 0){
      const total = LANDMARKS.length;
      const index = idx + 1;
      drawSign(LANDMARKS[idx].name, `Landmark ${index} of ${total}`);
    }
  }

  let last = performance.now();
  function loop(now){
    const dt = Math.min(0.05, (now - last)/1000);
    last = now;

    // end actions
    if ((state.mode === "paw" || state.mode === "eat") && now >= state.actionUntil){
      state.mode = (state.vx !== 0) ? "walk" : "idle";
    }

    // walking
    if (state.mode !== "sleep" && state.vx !== 0 && !(state.mode === "paw" || state.mode === "eat")){
      state.mode = "walk";
      state.t = clamp(state.t + state.vx * SPEED * dt, 0, 1);
    } else if (!(state.mode === "paw" || state.mode === "eat" || state.mode === "sleep")){
      state.mode = "idle";
    }

    // update animations
    for (const k in sprites) sprites[k].update(dt);

    // landmark message / voice (no bark here)
    const idx = currentLandmarkIndex();
    if (idx !== state.arrivedIndex){
      state.arrivedIndex = idx;
      if (idx >= 0){
        setMsg(`Arrived: ${LANDMARKS[idx].name} ‚Äî Landmark ${idx+1} of ${LANDMARKS.length}`);
        speak(LANDMARKS[idx].name);
      } else {
        setMsg("Exploring Yosemite‚Ä¶ üêæ");
      }
    }

    draw();
    requestAnimationFrame(loop);
  }

  boot();
})();
</script>
</body>
</html>
